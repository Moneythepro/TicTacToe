<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community v0.4 </title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Lucide icons (attempt CDN, fallback) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>

  <!-- Firebase (optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <meta name="description" content="Community — Premium Monochrome final build">

  <style>
    /* =================================================
       Premium Monochrome — Final (updated)
    ================================================= */
    :root{
      --bg: #070707;
      --panel: #ffffff;
      --text: #ffffff;
      --muted: #9fa5aa;
      --ref-blue: #6dd3ff;
      --maxw: 1200px;
      --gap: 14px;
      --radius: 12px;
      --hl-speed: 0.36;
      --thumb-max: 520px;
      --menu-width: 320px;
      --card: #0f1112;
      --glass-border: rgba(255,255,255,0.02);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.6);
      --accent-2: var(--ref-blue);
    }

    * { box-sizing: border-box; }
    html,body{ height:100%; margin:0; font-family:Inter, "Space Grotesk", system-ui, -apple-system, "Segoe UI", Roboto, Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background:var(--bg); color:var(--text); -webkit-tap-highlight-color:transparent; }

    /* subtle animated radial background */
    body::before, body::after{ content:""; position:fixed; inset:-20%; z-index:-2; pointer-events:none; background-repeat:no-repeat; background-size:60% 60%; opacity:0.035; filter: blur(72px); }
    body::before{ background-image: radial-gradient(circle at 8% 20%, rgba(255,255,255,0.04), transparent 24%); animation: driftA 16s ease-in-out infinite alternate; }
    body::after{ background-image: radial-gradient(circle at 92% 80%, rgba(255,255,255,0.02), transparent 20%); animation: driftB 20s ease-in-out infinite alternate-reverse; }
    @keyframes driftA { from{ transform: translateY(-6%) } to{ transform: translateY(6%) } }
    @keyframes driftB { from{ transform: translateY(6%) } to{ transform: translateY(-6%) } }

    .page { max-width:var(--maxw); margin:18px auto; padding:16px; }

    /* header */
    .header { position:sticky; top:12px; z-index:120; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:12px; backdrop-filter: blur(8px) saturate(120%); background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img#siteLogo{ width:28px; height:28px; object-fit:contain; border-radius:6px; display:block; }
    .brand .title { font-family:"Space Grotesk"; font-weight:800; font-size:18px; letter-spacing:-0.01em; color:var(--text); }

    .hdr-actions { display:flex; gap:8px; align-items:center; }
    .icon-btn { width:44px; height:40px; display:grid; place-items:center; border-radius:10px; border:none; background:transparent; color:var(--text); cursor:pointer; }
    .icon-btn:active{ transform: translateY(1px); }

    /* highlights (single-line title clamp) */
    .highlights { margin-top:16px; }
    .hl-viewport { overflow:hidden; width:100%; border-radius:12px; padding:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); }
    .hl-inner { display:flex; gap:12px; align-items:center; padding-left:8px; padding-right:8px; will-change:scroll-left; }
    .hl-item { flex:0 0 calc((100% / 3) - 16px); max-width: calc((100% / 3) - 16px); aspect-ratio:16/9; border-radius:10px; overflow:hidden; cursor:pointer; position:relative; background:#111; border:1px solid rgba(0,0,0,0.3); box-shadow: 0 12px 36px rgba(0,0,0,0.6); }
    .hl-item img{ width:100%; height:100%; object-fit:cover; display:block; }
    .hl-caption { position:absolute; left:10px; right:10px; bottom:10px; color:#fff; font-weight:800; font-size:12px; text-shadow: 0 8px 22px rgba(0,0,0,0.6); display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:calc(100% - 24px); }

    /* layout */
    .layout { display:grid; grid-template-columns: 1fr 340px; gap:20px; margin-top:18px; align-items:start; }
    @media (max-width:1000px){ .layout{ grid-template-columns:1fr; } .hl-item{ flex:0 0 calc((100% / 2) - 10px); max-width: calc((100% / 2) - 10px); } }


/* video list wrapper */
.video-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
}

/* Each video row: desktop = horizontal, mobile = stacked */
.video-row {
  width: 100%;
  display: flex;
  gap: 12px;
  align-items: flex-start;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.02);
  cursor: pointer;
  transition: transform .12s, box-shadow .12s;
  box-sizing: border-box;
}
.video-row:hover {
  transform: translateY(-4px);
  box-shadow: 0 18px 48px rgba(0,0,0,0.6);
}

/* THUMBNAIL WRAPPER — reliable 16:9 block */
.video-thumb {
  position: relative;
  width: 40%;
  max-width: var(--thumb-max, 520px);
  border-radius: 10px;
  overflow: hidden;
  background: #111;
  flex-shrink: 0;
}

/* 16:9 using padding-box (Android/iOS safe) */
.video-thumb::before {
  content: "";
  display: block;
  padding-top: 56.25%; /* 16:9 */
}

/* image fills the padding-box */
.video-thumb img {
  position: absolute !important;
  inset: 0;
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block !important;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

/* video meta (title + channel + category) */
.video-meta {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 60%;
  min-width: 0;
  box-sizing: border-box;
  padding: 2px 4px;
}

.video-title {
  font-style: italic;
  font-weight: 800;
  font-size: 16px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* channel row */
.channel-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.channel-avatar {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  overflow: hidden;
  flex-shrink: 0;
}
.channel-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-cat {
  font-size: 13px;
  color: var(--muted);
}

/* ------------------------------------------
   MOBILE — clean stacking & perfect 16:9
------------------------------------------ */
@media (max-width: 700px) {
  .video-row {
    flex-direction: column;
    padding: 10px;
    gap: 10px;
  }

  .video-thumb {
    width: 100% !important;
    max-width: 100% !important;
    border-radius: 12px;
  }

  /* keep pure 16:9 — DO NOT CAP HEIGHT */
  .video-thumb::before {
    padding-top: 56.25%;
  }

  .video-thumb img {
    inset: 0;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }

  .video-meta {
    width: 100%;
  }

  .video-title {
    font-size: 15px;
    white-space: normal;
    -webkit-line-clamp: 2;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}

/* Extra safety (you can remove if everything works) */
.video-list,
.video-row,
.video-thumb,
.video-thumb::before,
.video-thumb img,
.video-meta {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Desktop hard height cap (optional) */
@media (min-width: 701px) {
  .video-thumb {
    max-height: 420px;
  }
}

    /* side menu */
    .side-backdrop { position:fixed; inset:0; z-index:200; display:none; background:rgba(0,0,0,0.4); }
    .side-backdrop.open { display:block; }
    .side-menu { position:fixed; left:-100%; top:0; height:100%; width:var(--menu-width); max-width:92vw; background:var(--panel); color:#0a0a0a; box-shadow: 40px 0 120px rgba(0,0,0,0.6); z-index:210; padding:18px; transition: left .34s cubic-bezier(.2,.9,.2,1); display:flex; flex-direction:column; gap:12px; outline:none; }
    .side-menu.open{ left:0; }
    .side-menu h3{ margin:0; font-size:18px; font-weight:800; color:#111; }
    .menu-list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .menu-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:10px; cursor:pointer; background:#f6f6f6; color:#111; border:1px solid #e6e6e6; font-weight:800; }
    .menu-item.disabled{ opacity:0.6; filter:grayscale(.06); pointer-events:none; }
    .menu-note{ font-size:13px; color:#666; margin-top:6px; }
    .ref-text { color:var(--ref-blue); text-shadow: 0 6px 18px rgba(108,210,255,0.06); font-weight:700; }

    /* persistent search */
    .search-section { margin-top:12px; position:relative; z-index:200; }
    .search-card { display:flex; align-items:center; gap:8px; padding:10px; border-radius:12px; background:var(--card); border:1px solid var(--glass-border); box-shadow:var(--shadow-lg); }
    .search-icon{ width:20px; height:20px; opacity:0.9; }
    .search-input { flex:1; border:0; outline:0; font-size:15px; background:transparent; color:var(--text); padding:6px 2px; }
    .search-results { margin-top:8px; border-radius:12px; overflow-y:auto; max-height:52vh; background:var(--card); border:1px solid var(--glass-border); box-shadow:var(--shadow-lg); transition:opacity .18s, transform .18s; opacity:0; transform:translateY(-6px); pointer-events:none; position:relative; z-index:250; }
    .search-results.open{ opacity:1; transform:translateY(0); pointer-events:auto; }
    .search-result{ display:flex; gap:10px; align-items:center; padding:10px; text-decoration:none; color:inherit; border-bottom:1px solid rgba(0,0,0,0.03); cursor:pointer; }
    .search-result:last-child{ border-bottom:0; }
    .search-result:hover, .search-result.selected{ background: linear-gradient(90deg, rgba(109,211,255,0.04), rgba(109,211,255,0.02)); transform: translateX(3px); }
    .sr-thumb{ width:56px; height:56px; border-radius:8px; overflow:hidden; flex:0 0 56px; }
    .sr-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .sr-name{ font-weight:800; font-size:14px; line-height:1.1; }
    .sr-meta{ font-size:12px; color:var(--muted); margin-top:4px; font-weight:700; }

    /* floating chat button */
    .floating-chat { position:fixed; right:18px; bottom:18px; z-index:220; width:56px; height:56px; border-radius:999px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); display:grid; place-items:center; background:linear-gradient(180deg,#fff,#eee); cursor:pointer; }
    .floating-chat img{ width:36px; height:36px; object-fit:cover; border-radius:50%; }

    /* premium modal (used to prompt sign-in if action requires it) */
    .premium-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:260; background:rgba(0,0,0,0.6); }
    .premium-backdrop.open{ display:flex; }
    .premium-card{ width:min(540px,92vw); background:#fff; color:#111; padding:18px; border-radius:12px; box-shadow:0 40px 120px rgba(0,0,0,0.6); }

    /* confirm sign-out modal (hidden by default) */
    .confirm-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:270; background:rgba(0,0,0,0.6); }
    .confirm-backdrop.open{ display:flex; }
    .confirm-card{ width:min(520px,92vw); background:#fff; color:#111; padding:16px; border-radius:12px; box-shadow:0 40px 120px rgba(0,0,0,0.6); }

    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; top:auto; overflow:hidden; }
  </style>
</head>
<body>
  <main class="page" id="app">
    <header class="header" role="banner" aria-label="Community header">
      <div class="brand">
        <!-- Logo: recommended filename in repo: assets/logo.png -->
        <img id="siteLogo" src="https://raw.githubusercontent.com/Moneythepro/BoombaeGameStore/main/assets/logo.png" alt="logo" onerror="this.style.display='none'"/>
        <div class="title">Community</div>
      </div>

      <div class="hdr-actions" role="toolbar" aria-label="Header actions">
        <!-- Upload icon (left of menu). If not signed in will prompt sign-in modal -->
        <button id="uploadBtn" class="icon-btn" title="Upload / Showcase (upload)" aria-label="Upload to showcase">
          <span class="icon-placeholder" data-icon="upload"></span>
        </button>

        <!-- menu -->
        <button id="openMenuBtn" class="icon-btn" aria-label="Open menu" title="Menu">
          <span class="icon-placeholder" data-icon="menu" data-size="18"></span>
        </button>
      </div>
    </header>

    <!-- Search -->
    <section class="search-section" id="searchSection" aria-label="Search videos">
      <div class="search-card" role="search" aria-label="Search videos">
        <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21.53 20.47l-4.82-4.82A7.92 7.92 0 0018 10a8 8 0 10-8 8 7.92 7.92 0 005.65-1.29l4.82 4.82a.75.75 0 001.06-1.06zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"/></svg>
        <input id="searchInput" class="search-input" placeholder="Search videos, categories or tags..." autocomplete="off" aria-label="Search videos" />
      </div>
      <div id="searchResults" class="search-results" role="listbox" aria-live="polite"></div>
    </section>

    <!-- Highlights -->
    <section class="highlights" aria-label="Highlights">
      <div id="hlViewport" class="hl-viewport" tabindex="0" aria-label="Highlights carousel">
        <div id="hlInner" class="hl-inner" aria-live="polite"></div>
      </div>
    </section>

    <!-- Main layout (sidebar boxes removed per request) -->
    <div class="layout" role="main">
      <div class="content">
        <section id="videoList" class="video-list" aria-live="polite"></section>
      </div>

      <aside class="sidebar" aria-label="Sidebar">
        <!-- removed Account + Support panels as requested -->
      </aside>
    </div>
  </main>

  <!-- Side menu -->
  <div id="sideBackdrop" class="side-backdrop" aria-hidden="true"></div>
  <aside id="sideMenu" class="side-menu" role="dialog" aria-modal="true" aria-label="Main menu" tabindex="-1">
    <h3>Menu</h3>
    <div id="menuProfileArea"></div>

    <div class="menu-list" id="menuList">
      <div id="mi_signin" class="menu-item" role="button" tabindex="0">
        <div>
          <div>Sign in with Google</div>
          <div class="menu-note">Sign in once to access Chat & Showcase</div>
        </div>
        <div class="ref-text">GO</div>
      </div>

      <div id="mi_signout" class="menu-item disabled" role="button" tabindex="0" style="display:none;">
        <div>
          <div>Sign out</div>
          <div class="menu-note">Sign out from your account</div>
        </div>
        <div>OUT</div>
      </div>

      <div id="mi_chat" class="menu-item disabled" role="button" tabindex="0">
        <div>
          <div>Community Chat</div>
          <div class="menu-note">Enter live rooms</div>
        </div>
        <div class="ref-text">OPEN</div>
      </div>

      <div id="mi_showcase" class="menu-item disabled" role="button" tabindex="0">
        <div>
          <div>Showcase</div>
          <div class="menu-note">Upload or browse shared works</div>
        </div>
        <div class="ref-text">OPEN</div>
      </div>

      <div id="mi_support" class="menu-item" role="button" tabindex="0">
        <div>
          <div>Customer Support</div>
          <div class="menu-note">Contact support or open help docs</div>
        </div>
        <div>HELP</div>
      </div>

      <div id="mi_privacy" class="menu-item" role="button" tabindex="0">
        <div>
          <div>Privacy Policy</div>
          <div class="menu-note">Read our privacy policy</div>
        </div>
        <div>VIEW</div>
      </div>

      <div id="mi_guidelines" class="menu-item" role="button" tabindex="0">
        <div>
          <div>Community Guidelines</div>
          <div class="menu-note">Rules & best practices</div>
        </div>
        <div>READ</div>
      </div>
    </div>
  </aside>

  <!-- floating chat button -->
  <div id="floatingChat" class="floating-chat" title="Open community chat" aria-label="Open community chat">
    <!-- recommended filename in repo: assets/floating.png -->
    <img id="floatingChatImg" src="https://raw.githubusercontent.com/Moneythepro/BoombaeGameStore/main/assets/floating.png" alt="chat" onerror="this.src='https://raw.githubusercontent.com/Moneythepro/BoombaeGameStore/main/assets/channel-default.png'"/>
  </div>

  <!-- Premium modal shown when user must sign-in -->
  <div id="premiumBackdrop" class="premium-backdrop" aria-hidden="true">
    <div class="premium-card" role="dialog" aria-modal="true" aria-label="Sign in required">
      <div style="font-weight:800;font-size:18px">Sign in required</div>
      <div style="margin-top:12px;color:#444">You must sign in to access Community Chat and Upload features. Sign in with Google to continue.</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px">
        <button id="premiumClose" style="padding:10px 12px;border-radius:8px;border:none;background:#e9e9e9;color:#111;cursor:pointer;font-weight:800">Close</button>
        <button id="premiumSignIn" style="padding:10px 12px;border-radius:8px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:800">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Confirm logout modal (hidden until requested) -->
  <div id="confirmBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="confirm-card" role="dialog" aria-modal="true" aria-label="Confirm sign out">
      <div style="font-weight:800;font-size:16px">Confirm sign out</div>
      <div style="margin-top:8px;color:#666">Are you sure you want to sign out?</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
        <button id="cancelLogoutBtn" style="padding:10px 12px;border-radius:8px;border:none;background:#e9e9e9;color:#111;cursor:pointer;font-weight:800">Cancel</button>
        <button id="confirmLogoutBtn" style="padding:10px 12px;border-radius:8px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:800">Sign out</button>
      </div>
    </div>
  </div>

  <!-- Inline fallback SVGs -->
  <template id="svgFallback">
    <svg id="svg-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    <svg id="svg-upload" viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
  </template>

  <script>
  (function () {
    /* -------------------------
       CONFIG
       ------------------------- */
    // YouTube API key you provided (client-side). If you want to hide it, move calls server-side.
    const API_KEY = 'AIzaSyA97DNGHIF85wLeIlDndNtOWTA6BofbJ0A';

    // GitHub raw base for images (your repo)
    const GH_RAW_BASE = 'https://raw.githubusercontent.com/Moneythepro/BoombaeGameStore/main/assets';

    // Firebase config (optional)
    const firebaseConfig = {
      apiKey: "AIzaSyCPVer1Qg4ecHxbUKHUst8C0dyPCm8LEkM",
      authDomain: "community-7bd8d.firebaseapp.com",
      projectId: "community-7bd8d",
      storageBucket: "community-7bd8d.firebasestorage.app",
      messagingSenderId: "1034615155630",
      appId: "1:1034615155630:web:e4ee92c96c3a04875f363f",
      measurementId: "G-BW2QDBG8GC"
    };

    /* -------------------------
       DOM refs
       ------------------------- */
    const $ = id => document.getElementById(id);
    let sideBackdropEl, sideMenuEl, openMenuBtnEl, uploadBtnEl, menuProfileAreaEl;
    let mi_signin_el, mi_signout_el, mi_chat_el, mi_showcase_el, mi_support_el, mi_privacy_el, mi_guidelines_el;
    let hlViewportEl, hlInnerEl, videoListEl;
    let floatingChatEl, premiumBackdropEl, premiumSignInBtn, premiumCloseBtn;
    let searchInputEl, searchResultsEl, floatingChatImg;

    /* -------------------------
       Firebase handles
       ------------------------- */
    let auth = null;
    let db = null;
    let currentUser = null;

    /* -------------------------
       Video cache: id -> metadata
       ------------------------- */
    let videoCache = [];

    /* -------------------------
       Demo fallback videos
       ------------------------- */
    const DEMO_VIDEOS = [
      { videoId: 'dQw4w9WgXcQ', title: 'Demo Intro', category: 'Intro', tags: [] },
      { videoId: 'M7lc1UVf-VE', title: 'Demo Tutorial', category: 'Tutorial', tags: [] },
      { videoId: 'sNPnbI1arSE', title: 'Demo Showcase', category: 'Showcase', tags: [] },
      { videoId: 'kXYiU_JCYtU', title: 'Demo Interview', category: 'Interview', tags: [] },
      { videoId: '3JZ_D3ELwOQ', title: 'Demo Design', category: 'Design', tags: [] },
      { videoId: 'e-ORhEE9VVg', title: 'Demo Short', category: 'Shorts', tags: [] }
    ];

    /* -------------------------
       Icon init: lucide or fallback
       ------------------------- */
    function initIcons(attempts = 10, delay = 60) {
      const placeholders = document.querySelectorAll('.icon-placeholder');
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        placeholders.forEach(p => {
          const name = (p.getAttribute('data-icon') || '').trim() || 'menu';
          const i = document.createElement('i');
          i.setAttribute('data-lucide', name);
          p.replaceWith(i);
        });
        try { window.lucide.createIcons({ className: 'lucide' }); } catch (e) { mountFallbackIcons(); }
        return;
      }
      if (attempts <= 0) { mountFallbackIcons(); return; }
      setTimeout(() => initIcons(attempts - 1, delay), delay);
    }
    function mountFallbackIcons(){
      const tpl = $('svgFallback');
      if (!tpl) return;
      const map = {};
      Array.from(tpl.content.children).forEach(svg => map[svg.id.replace(/^svg-/,'')] = svg.outerHTML);
      document.querySelectorAll('.icon-placeholder').forEach(el => {
        const name = el.getAttribute('data-icon') || 'menu';
        el.outerHTML = map[name] || map['menu'] || '<svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="currentColor"/></svg>';
      });
    }

    /* -------------------------
       Firebase: optional init
       ------------------------- */
    function tryInitFirebase(){
      try {
        if (typeof firebase !== 'undefined' && firebase && firebase.initializeApp) {
          try { firebase.initializeApp(firebaseConfig); } catch (e) { /* ignore already inited */ }
          if (firebase.auth) auth = firebase.auth();
          if (firebase.firestore) db = firebase.firestore();
        }
      } catch (e) {
        console.warn('Firebase init failed or not available', e);
        auth = null; db = null;
      }
    }

    /* -------------------------
       YouTube API helpers (client-side)
       - Uses API_KEY set above
       - videos.list (snippet,statistics,contentDetails) then channels.list for thumbnails
       - Caches channel thumbnails to avoid repeated calls
       ------------------------- */
    async function fetchVideoDetailsBatch(videoIds) {
      // videoIds: array of 1..50 IDs
      if (!API_KEY) return {};
      const ids = Array.from(new Set(videoIds.filter(Boolean))).join(',');
      if (!ids) return {};
      try {
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${encodeURIComponent(ids)}&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('videos.list failed');
        const json = await res.json();
        const out = {};
        if (Array.isArray(json.items)) {
          json.items.forEach(it => {
            out[it.id] = it;
          });
        }
        return out;
      } catch (e) {
        console.warn('fetchVideoDetailsBatch error', e);
        return {};
      }
    }

    const channelCache = {};
    async function fetchChannelInfo(channelIds) {
      // Accept array
      const ids = Array.from(new Set(channelIds.filter(Boolean)));
      const missing = ids.filter(id => !channelCache[id]);
      if (missing.length === 0) {
        const pick = {};
        ids.forEach(id => pick[id] = channelCache[id]);
        return pick;
      }
      // batch up to 50
      try {
        const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${encodeURIComponent(missing.join(','))}&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('channels.list failed');
        const json = await res.json();
        if (Array.isArray(json.items)) {
          json.items.forEach(ch => {
            channelCache[ch.id] = {
              title: ch.snippet?.title || '',
              thumbnail: ch.snippet?.thumbnails?.default?.url || ch.snippet?.thumbnails?.medium?.url || ch.snippet?.thumbnails?.high?.url || ''
            };
          });
        }
      } catch (e) {
        console.warn('fetchChannelInfo error', e);
      }
      const pick = {};
      ids.forEach(id => pick[id] = channelCache[id] || { title: '', thumbnail: '' });
      return pick;
    }

    /* -------------------------
       YouTube oEmbed title fallback
       ------------------------- */
    async function fetchOEmbedTitle(id){
      if (!id) return '';
      try {
        const r = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
        if (!r.ok) throw new Error('oembed failed');
        const j = await r.json();
        return (j.title || '').trim();
      } catch (e) {
        return '';
      }
    }

    /* -------------------------
       Video loading pipeline
       - Firestore -> localStorage -> demo
       - Then augment with YouTube API when possible
       ------------------------- */
    async function loadVideos(){
      let list = [];
      if (db) {
        try {
          const snap = await db.collection('community_videos').orderBy('publishedAt','desc').get();
          snap.forEach(doc => {
            const d = doc.data();
            const id = extractYouTubeID(d.videoId || d.youtube || d.link || '');
            list.push({
              videoId: id,
              title: d.title ? String(d.title).trim() : '',
              category: d.category || '',
              tags: d.tags || []
            });
          });
        } catch (e) {
          console.warn('Firestore read failed or permission denied', e);
          list = [];
        }
      }

      if (!list.length) {
        try {
          const raw = localStorage.getItem('community_videos');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed) && parsed.length) {
              list = parsed.map(p => ({ videoId: extractYouTubeID(p.videoId||p.id||''), title: p.title ? String(p.title).trim() : '', category: p.category || '', tags: p.tags || [] }));
            }
          }
        } catch(e){}
      }

      if (!list.length) {
        list = DEMO_VIDEOS.map(d => ({ videoId: d.videoId, title: d.title || '', category: d.category || '', tags: d.tags || [] }));
      }

      // fetch missing titles (limited)
      const needs = list.filter(v => !v.title && v.videoId).slice(0,8);
      await Promise.all(needs.map(async v => {
        const t = await fetchOEmbedTitle(v.videoId);
        if (t) v.title = t;
      }));

      // final fallback guard
      list.forEach(v => { if (!v.title) v.title = 'Untitled'; });

      // augment: fetch official snippet + channel info via API when possible (in batches)
      const ids = list.map(v => v.videoId).filter(Boolean);
      if (ids.length && API_KEY) {
        // split into chunks of 50
        const chunks = [];
        for (let i=0;i<ids.length;i+=50) chunks.push(ids.slice(i, i+50));
        const vidMap = {};
        for (const chunk of chunks) {
          const details = await fetchVideoDetailsBatch(chunk);
          Object.assign(vidMap, details);
        }
        // collect channelIds
        const channelIds = [];
        list.forEach(v => {
          const info = vidMap[v.videoId];
          if (info && info.snippet) {
            v.title = info.snippet.title || v.title;
            v.channelId = info.snippet.channelId || '';
            v.channelTitle = info.snippet.channelTitle || '';
          }
          if (v.channelId) channelIds.push(v.channelId);
        });
        if (channelIds.length) {
          const chMap = await fetchChannelInfo(channelIds);
          list.forEach(v => {
            if (v.channelId && chMap[v.channelId]) {
              v.channelAvatar = chMap[v.channelId].thumbnail || `${GH_RAW_BASE}/channel-default.png`;
              v.channelTitle = v.channelTitle || chMap[v.channelId].title || '';
            } else {
              v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`;
            }
          });
        } else {
          // fallback channel avatar default
          list.forEach(v => v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`);
        }
      } else {
        // No API key or no ids: fallback avatars
        list.forEach(v => v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`);
      }

      return list;
    }

    /* -------------------------
       Helpers: YouTube id extraction + simple utilities
       ------------------------- */
    function extractYouTubeID(input){
      if (!input) return '';
      if (/^[A-Za-z0-9_-]{11}$/.test(input)) return input;
      const m = input.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      const mm = input.match(/([A-Za-z0-9_-]{11})/);
      return mm ? mm[1] : '';
    }
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /* -------------------------
       DOM builders
       ------------------------- */
    function buildHighlightNode(item){
      const a = document.createElement('a');
      a.className = 'hl-item';
      a.href = `video_player.html?vid=${encodeURIComponent(item.videoId)}`;
      a.setAttribute('aria-label', item.title || 'highlight');
      a.tabIndex = 0;

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = item.title || 'thumbnail';
      img.src = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      img.onerror = () => { if (!img.dataset.err){ img.dataset.err='1'; img.src = `https://i.ytimg.com/vi/${item.videoId}/mqdefault.jpg`; } };

      const cap = document.createElement('div');
      cap.className = 'hl-caption';
      cap.textContent = item.title || '';

      a.appendChild(img);
      a.appendChild(cap);
      return a;
    }

    function buildVideoRow(item){
      const row = document.createElement('article');
      row.className = 'video-row';
      row.tabIndex = 0;
      row.onclick = () => { window.location.href = `video_player.html?vid=${encodeURIComponent(item.videoId)}`; };
      row.onkeypress = (e) => { if (e.key === 'Enter') row.onclick(); };

      const thumb = document.createElement('div');
      thumb.className = 'video-thumb';
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = item.title || 'thumbnail';
      img.src = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      img.onerror = () => { if (!img.dataset.err){ img.dataset.err='1'; img.src = `https://i.ytimg.com/vi/${item.videoId}/mqdefault.jpg`; } };
      thumb.appendChild(img);

      const meta = document.createElement('div');
      meta.className = 'video-meta';
      const title = document.createElement('div');
      title.className = 'video-title';
      title.textContent = item.title || 'Untitled';

      // show channel avatar + title row
      const channelRow = document.createElement('div');
      channelRow.className = 'channel-row';
      const chAvatar = document.createElement('div');
      chAvatar.className = 'channel-avatar';
      const chImg = document.createElement('img');
      chImg.alt = item.channelTitle || 'channel';
      chImg.src = item.channelAvatar || `${GH_RAW_BASE}/channel-default.png`;
      chImg.onerror = () => { if (!chImg.dataset.err){ chImg.dataset.err='1'; chImg.src = `${GH_RAW_BASE}/channel-default.png`; } };
      chAvatar.appendChild(chImg);

      const chTitle = document.createElement('div');
      chTitle.style.fontWeight = '700';
      chTitle.style.fontSize = '13px';
      chTitle.textContent = item.channelTitle || '';

      channelRow.appendChild(chAvatar);
      channelRow.appendChild(chTitle);

      const cat = document.createElement('div');
      cat.className = 'video-cat';
      cat.textContent = item.category || '';

      meta.appendChild(title);
      meta.appendChild(channelRow);
      meta.appendChild(cat);

      row.appendChild(thumb);
      row.appendChild(meta);
      return row;
    }

    /* -------------------------
       Renderers + autoplay highlight
       ------------------------- */
    function renderHighlights(list){
      const pool = list.slice();
      for (let i = pool.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      const picks = pool.slice(0, Math.min(pool.length, 6));
      hlInnerEl.innerHTML = '';
      picks.forEach(p => hlInnerEl.appendChild(buildHighlightNode(p)));
      picks.forEach(p => hlInnerEl.appendChild(buildHighlightNode(p))); // duplicate
      hlViewportEl.scrollLeft = 0;
    }

    function renderVideoList(list){
      const arr = list.slice();
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      videoListEl.innerHTML = '';
      arr.forEach(v => videoListEl.appendChild(buildVideoRow(v)));
    }

    let autoTimer = null;
    function startAuto(){ if (autoTimer) return; const speed = Number(getComputedStyle(document.documentElement).getPropertyValue('--hl-speed')) || 0.36; autoTimer = setInterval(()=>{ hlViewportEl.scrollLeft += speed; const half = hlInnerEl.scrollWidth/2 || 0; if (half && hlViewportEl.scrollLeft >= half){ hlViewportEl.scrollLeft = hlViewportEl.scrollLeft - half; } }, 16); }
    function stopAuto(){ if (autoTimer){ clearInterval(autoTimer); autoTimer = null; } }

    /* -------------------------
       Menu open/close
       ------------------------- */
    function openSideMenu(){ sideBackdropEl.classList.add('open'); sideBackdropEl.setAttribute('aria-hidden','false'); sideMenuEl.classList.add('open'); sideMenuEl.focus(); }
    function closeSideMenu(){ sideMenuEl.classList.remove('open'); sideBackdropEl.classList.remove('open'); sideBackdropEl.setAttribute('aria-hidden','true'); }

    function setMenuEnabled(el, enabled){ if (!el) return; if (enabled) el.classList.remove('disabled'); else el.classList.add('disabled'); }

    /* -------------------------
       Auth (Google popup) - optional
       ------------------------- */
    async function doGoogleSignIn(){
      if (!auth){
        menuProfileAreaEl.innerHTML = `<div style="color:#333">Google sign-in isn't configured in this environment.</div>`;
        return;
      }
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const res = await auth.signInWithPopup(provider);
        currentUser = res.user;
        updateUIForAuth(currentUser);
        closeSideMenu();
      } catch (err) {
        console.error('Sign-in failed', err);
        menuProfileAreaEl.innerHTML = `<div style="color:#333">Sign-in failed (popup blocked or configuration issue).</div>`;
      }
    }

    function openConfirmLogout(){ $('confirmBackdrop').classList.add('open'); $('confirmBackdrop').setAttribute('aria-hidden','false'); }
    function closeConfirmLogout(){ $('confirmBackdrop').classList.remove('open'); $('confirmBackdrop').setAttribute('aria-hidden','true'); }

    async function confirmAndSignOut(){
      if (!auth){
        currentUser = null;
        updateUIForAuth(null);
        closeConfirmLogout();
        closeSideMenu();
        return;
      }
      try {
        await auth.signOut();
        currentUser = null;
        updateUIForAuth(null);
        closeConfirmLogout();
        closeSideMenu();
      } catch (e) {
        console.error('Sign-out failed', e);
        menuProfileAreaEl.innerHTML = `<div style="color:#333">Unable to sign out. Try again.</div>`;
      }
    }

    /* -------------------------
       Update UI after auth change
       ------------------------- */
    function updateUIForAuth(user){
      currentUser = user;
      const logged = !!user;
      // Hide/Show flow
      if (mi_signin_el) mi_signin_el.style.display = logged ? 'none' : '';
      if (mi_signout_el) mi_signout_el.style.display = logged ? '' : 'none';
      // enable chat/showcase when logged
      setMenuEnabled(mi_chat_el, logged);
      setMenuEnabled(mi_showcase_el, logged);

      // update menu profile area
      menuProfileAreaEl.innerHTML = '';
      if (logged){
        menuProfileAreaEl.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${escapeHtml(user.photoURL || (GH_RAW_BASE + '/channel-default.png'))}" style="width:56px;height:56px;border-radius:999px;border:2px solid rgba(0,0,0,0.06)" alt="profile" />
            <div>
              <div style="font-weight:800">${escapeHtml(user.displayName || '')}</div>
              <div style="color:#666;font-size:13px">${escapeHtml(user.email || '')}</div>
            </div>
          </div>
        `;
      } else {
        menuProfileAreaEl.innerHTML = `<div style="font-weight:800;color:#111">Welcome</div><div class="menu-note">Sign in to unlock Chat & Showcase.</div>`;
      }

      // update menu-note content to not talk about "requires sign-in" when signed in
      const chatNote = mi_chat_el && mi_chat_el.querySelector('.menu-note');
      const showNote = mi_showcase_el && mi_showcase_el.querySelector('.menu-note');
      if (chatNote) chatNote.textContent = logged ? 'Enter live rooms' : 'Enter live rooms';
      if (showNote) showNote.textContent = logged ? 'Upload or browse shared works' : 'Upload or browse shared works';
    }

    /* -------------------------
       Premium modal open/close
       ------------------------- */
    function openPremiumModal(){ premiumBackdropEl.classList.add('open'); premiumBackdropEl.setAttribute('aria-hidden','false'); }
    function closePremiumModal(){ premiumBackdropEl.classList.remove('open'); premiumBackdropEl.setAttribute('aria-hidden','true'); }

    /* -------------------------
       Search (debounced fuzzy scoring)
       ------------------------- */
    function debounce(fn, ms=180){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    let searchSelectedIndex = -1;
    function escapeRegExp(s){ return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); }
    function highlightMatch(text, query){
      if (!query) return text;
      try { const re = new RegExp('('+escapeRegExp(query)+')','ig'); return text.replace(re, '<mark style="background:transparent;color:var(--accent-2);font-weight:900">$1</mark>'); } catch(e){ return text; }
    }

    function createSearchResultNode(p, idx, term){
      const a = document.createElement('div');
      a.className = 'search-result';
      a.tabIndex = 0;
      a.setAttribute('data-index', idx);

      const thumb = document.createElement('div');
      thumb.className = 'sr-thumb';
      const timg = document.createElement('img');
      timg.src = `https://i.ytimg.com/vi/${p.videoId}/hqdefault.jpg`;
      timg.alt = p.title || '';
      timg.addEventListener('error', ()=>{ timg.onerror=null; timg.src='https://via.placeholder.com/160x90?text=No'; });
      thumb.appendChild(timg);

      const meta = document.createElement('div');
      const name = document.createElement('div');
      name.className = 'sr-name';
      name.innerHTML = highlightMatch(escapeHtml(p.title || ''), term);
      const metaSub = document.createElement('div');
      metaSub.className = 'sr-meta';
      metaSub.textContent = `${p.category || ''}${p.tags && p.tags.length ? ' • ' + p.tags.join(', ') : ''}`;

      meta.appendChild(name);
      meta.appendChild(metaSub);

      a.appendChild(thumb);
      a.appendChild(meta);

      a.addEventListener('click', () => {
        window.location.href = `video_player.html?vid=${encodeURIComponent(p.videoId)}`;
      });

      return a;
    }

    const doSearch = debounce((q) => {
      if (!searchResultsEl) return;
      searchResultsEl.classList.remove('open');
      searchResultsEl.innerHTML = '';
      searchSelectedIndex = -1;
      const term = String(q || '').trim();
      if (!term){
        return;
      }
      const lterm = term.toLowerCase();

      const scored = videoCache.map(p => {
        const name = (p.title || '').toLowerCase();
        const cat = (p.category || '').toLowerCase();
        const tags = (p.tags || []).map(t => String(t).toLowerCase()).join(' ');
        let score = 0;
        if (name === lterm) score += 300;
        if (name.startsWith(lterm)) score += 160;
        if (name.includes(lterm)) score += 100;
        if (cat.includes(lterm)) score += 70;
        if (tags.includes(lterm)) score += 60;
        const tokens = name.split(/\s+/);
        tokens.forEach(tok => { if (tok.startsWith(lterm)) score += 15; if (tok.includes(lterm)) score += 6; });
        if (score === 0){
          const overlap = simpleOverlapScore(name, lterm); score += overlap;
        }
        return { p, score };
      }).filter(x => x.score > 0).sort((a,b) => b.score - a.score).slice(0, 18);

      if (!scored.length){
        searchResultsEl.innerHTML = '<div style="padding:14px;color:#999">No results</div>';
        searchResultsEl.classList.add('open');
        return;
      }

      scored.forEach((s, idx) => {
        const node = createSearchResultNode(s.p, idx, term);
        searchResultsEl.appendChild(node);
      });

      searchResultsEl.classList.add('open');
    }, 160);

    function simpleOverlapScore(a,b){
      if (!a || !b) return 0;
      let score = 0;
      const setA = new Set(a.split('').filter(Boolean));
      for (const ch of b.split('')) if (setA.has(ch)) score += 1;
      return Math.min(40, score);
    }

    function updateSearchSelection(items){
      items.forEach((it, i) => {
        if (i === searchSelectedIndex){
          it.classList.add('selected');
          it.scrollIntoView({block:'nearest', behavior:'smooth'});
        } else {
          it.classList.remove('selected');
        }
      });
    }

    function wireSearchKeyboard(){
      searchInputEl.addEventListener('keydown', (ev) => {
        const items = Array.from(searchResultsEl.querySelectorAll('.search-result'));
        if (ev.key === 'ArrowDown'){
          ev.preventDefault();
          if (!items.length) return;
          searchSelectedIndex = Math.min(items.length - 1, searchSelectedIndex + 1);
          updateSearchSelection(items);
        } else if (ev.key === 'ArrowUp'){
          ev.preventDefault();
          if (!items.length) return;
          searchSelectedIndex = Math.max(0, searchSelectedIndex - 1);
          updateSearchSelection(items);
        } else if (ev.key === 'Enter'){
          const sel = items[searchSelectedIndex];
          if (sel) sel.click();
        } else if (ev.key === 'Escape'){
          searchInputEl.value = '';
          doSearch('');
          searchInputEl.blur();
        }
      });
    }

    /* -------------------------
       UI wiring
       ------------------------- */
    function wireUI(){
      openMenuBtnEl.addEventListener('click', (e) => { e.stopPropagation(); openSideMenu(); });
      sideBackdropEl.addEventListener('click', (e) => { if (e.target === sideBackdropEl) closeSideMenu(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape'){ closeSideMenu(); closePremiumModal(); closeConfirmLogout(); } });

      // full-row menu clicks
      mi_signin_el.addEventListener('click', () => { if (mi_signin_el.classList.contains('disabled')) return; doGoogleSignIn(); });
      mi_signout_el.addEventListener('click', () => { if (mi_signout_el.classList.contains('disabled')) return; openConfirmLogout(); });
      mi_chat_el.addEventListener('click', () => {
        if (mi_chat_el.classList.contains('disabled')) { openPremiumModal(); return; }
        window.location.href = 'community_chat.html';
      });
      mi_showcase_el.addEventListener('click', () => {
        if (mi_showcase_el.classList.contains('disabled')) { openPremiumModal(); return; }
        window.location.href = 'showcase.html';
      });
      mi_support_el.addEventListener('click', () => { window.location.href = 'support.html'; });
      mi_privacy_el.addEventListener('click', () => { window.location.href = 'pp.html'; });
      mi_guidelines_el.addEventListener('click', () => { window.location.href = 'community_guidelines.html'; });

      // upload icon
      uploadBtnEl.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!currentUser) { openPremiumModal(); return; }
        window.location.href = 'showcase.html';
      });

      // floating chat
      floatingChatEl.addEventListener('click', () => {
        if (!currentUser) { openPremiumModal(); return; }
        window.location.href = 'community_chat.html';
      });

      // premium modal buttons
      premiumSignInBtn.addEventListener('click', () => { closePremiumModal(); doGoogleSignIn(); });
      premiumCloseBtn.addEventListener('click', () => closePremiumModal());
      premiumBackdropEl.addEventListener('click', (e) => { if (e.target === premiumBackdropEl) closePremiumModal(); });

      // confirm logout handlers
      $('confirmLogoutBtn').addEventListener('click', () => confirmAndSignOut());
      $('cancelLogoutBtn').addEventListener('click', () => closeConfirmLogout());
      $('confirmBackdrop').addEventListener('click', (e) => { if (e.target === $('confirmBackdrop')) closeConfirmLogout(); });

      // search wiring
      searchInputEl.addEventListener('input', (e) => doSearch(e.target.value));
      wireSearchKeyboard();

      // close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchResultsEl.contains(e.target) && e.target !== searchInputEl) searchResultsEl.classList.remove('open');
      });
    }

    /* -------------------------
       Boot sequence
       ------------------------- */
    async function boot(){
      // assign DOM refs
      sideBackdropEl = $('sideBackdrop');
      sideMenuEl = $('sideMenu');
      openMenuBtnEl = $('openMenuBtn');
      uploadBtnEl = $('uploadBtn');
      menuProfileAreaEl = $('menuProfileArea');

      mi_signin_el = $('mi_signin');
      mi_signout_el = $('mi_signout');
      mi_chat_el = $('mi_chat');
      mi_showcase_el = $('mi_showcase');
      mi_support_el = $('mi_support');
      mi_privacy_el = $('mi_privacy');
      mi_guidelines_el = $('mi_guidelines');

      hlViewportEl = $('hlViewport');
      hlInnerEl = $('hlInner');
      videoListEl = $('videoList');

      floatingChatEl = $('floatingChat');
      floatingChatImg = $('floatingChatImg');
      premiumBackdropEl = $('premiumBackdrop');
      premiumSignInBtn = $('premiumSignIn');
      premiumCloseBtn = $('premiumClose');

      searchInputEl = $('searchInput');
      searchResultsEl = $('searchResults');

      // init icons
      initIcons();

      // try firebase
      tryInitFirebase();

      // initial menu states
      setMenuEnabled(mi_signin_el, true);
      setMenuEnabled(mi_signout_el, false);
      setMenuEnabled(mi_chat_el, false);
      setMenuEnabled(mi_showcase_el, false);
      if (mi_signout_el) mi_signout_el.style.display = 'none';

      wireUI();

      // load videos -> videoCache
      const videos = await loadVideos();
      videoCache = videos.map(v => ({ videoId: v.videoId, title: v.title, category: v.category, tags: v.tags || [], channelAvatar: v.channelAvatar || (GH_RAW_BASE + '/channel-default.png'), channelTitle: v.channelTitle || '' }));

      // title patch (non-blocking)
      videos.forEach(async v => {
        if ((!v.title || v.title === 'Untitled') && v.videoId) {
          const t = await fetchOEmbedTitle(v.videoId);
          if (t && t.length) v.title = t;
        }
      });

      renderHighlights(videos);
      renderVideoList(videos);
      startAuto();

      // auth listener
      if (auth) {
        auth.onAuthStateChanged(u => {
          currentUser = u;
          updateUIForAuth(u);
        });
      } else {
        if (menuProfileAreaEl) menuProfileAreaEl.innerHTML = `<div style="color:#333">Auth not configured in this environment. Sign-in will be unavailable.</div>`;
      }

      // expose helpers
      window.CommunityUI = { boot, startAuto, stopAuto };

      console.info('Community UI boot complete');
    }

    /* -------------------------
       Utility: minimal escape for template strings
       ------------------------- */
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // start
    document.addEventListener('DOMContentLoaded', boot);
  })();
  </script>
</body>
</html>
