<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community v0.4 — Updated</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Lucide (UMD) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>

  <!-- Firebase (optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <meta name="description" content="Community — Premium Monochrome final build (updated UI & UX)" />

  <style>

    :root{
      /* Premium dark + gold accent palette */
      --bg-verydark: #050405;       /* page background (near-black) */
      --bg-vignette: radial-gradient(800px 500px at 12% 18%, rgba(212,175,55,0.035), transparent 16%),
                     radial-gradient(700px 360px at 88% 82%, rgba(212,175,55,0.02), transparent 12%),
                     var(--bg-verydark);
      --panel-glass: rgba(12,12,13,0.68);  /* panels / cards (glass black) */
      --panel-strong: rgba(18,17,16,0.92); /* modal / menus deeper */
      --panel-border: rgba(255,255,255,0.03);
      --text-primary: #f7f3ea;    /* off-white / slightly warm */
      --text-muted: #a89f8e;      /* muted warm */
      --accent-gold: #D4AF37;     /* premium gold accent */
      --accent-gold-strong: #b88f2a;
      --link: #8fd6ff;
      --maxw: 1200px;
      --gap: 14px;
      --shadow-lg: 0 28px 80px rgba(0,0,0,0.7);
      --header-padding: 7px 10px; /* reduced by ~30% (was 10px 12px) */
    }

    /* ---------------------------
       enforce square corners everywhere
       --------------------------- */
    * { box-sizing: border-box; border-radius: 0 !important; }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, "Space Grotesk", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: var(--bg-vignette);
      color: var(--text-primary);
      -webkit-text-size-adjust:100%;
      -ms-text-size-adjust:100%;
    }

    /* subtle layered vignette (keeps background premium but not distracting) */
    body::before{
      content: "";
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -2;
      background: transparent;
    }

    .page { max-width: var(--maxw); margin: 16px auto; padding: 12px; }

    /* ===== HEADER (reduced height by ~30%) ===== */
    .header {
      position: sticky;
      top: 12px;
      z-index: 140;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: var(--header-padding);
      background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));
      border: 1px solid var(--panel-border);
      /* no rounding (square) */
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px) saturate(120%);
    }

    .brand {
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      justify-content:flex-start;
    }
    .brand .title {
      font-family: "Space Grotesk", Inter, sans-serif;
      font-weight:800;
      font-size:18px;
      letter-spacing: -0.01em;
      color: var(--text-primary);
      text-transform: uppercase;
      text-align: left;
    }

    .hdr-actions { display:flex; gap:8px; align-items:center; }
    .icon-btn {
      width:40px; height:36px; display:grid; place-items:center; background: transparent;
      border: 1px solid transparent; color: var(--text-primary); cursor:pointer;
    }
    .icon-btn:focus { outline: 3px solid rgba(212,175,55,0.12); outline-offset: 2px; }

    /* ===== Highlights (carousel) ===== */
    .highlights { margin-top: 12px; }
    .hl-viewport {
      overflow:hidden; width:100%;
      padding:8px; background: var(--panel-glass); border: 1px solid var(--panel-border);
      box-shadow: var(--shadow-lg);
    }
    .hl-inner { display:flex; gap:12px; padding-left:8px; padding-right:8px; align-items:center; }
    .hl-item {
      flex: 0 0 calc((100% / 3) - 16px);
      max-width: calc((100% / 3) - 16px);
      aspect-ratio: 16/9;
      overflow: hidden;
      position: relative;
      background: #0b0b0b;
      border: 1px solid rgba(0,0,0,0.2);
    }
    .hl-item img { width:100%; height:100%; object-fit:cover; display:block; }
    .hl-caption {
      position: absolute; left: 8px; right: 8px; bottom: 8px;
      color: var(--text-primary); font-weight:800; font-size:12px;
      text-shadow: 0 12px 30px rgba(0,0,0,0.6);
      white-space: nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* ===== Main layout ===== */
    .layout { display:grid; grid-template-columns: 1fr 340px; gap:20px; margin-top:14px; align-items:start; }
    @media (max-width:1000px){ .layout { grid-template-columns: 1fr; } .hl-item { flex: 0 0 calc((100%/2) - 10px); } }

    /* ==== Video list rows (cards updated to premium) ==== */
    .video-list { display:flex; flex-direction:column; gap:14px; width:100%; }
    .video-row {
      display:flex; gap:12px; align-items:flex-start; padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
      border: 1px solid var(--panel-border);
      box-shadow: 0 12px 36px rgba(0,0,0,0.55);
      cursor:pointer; transition: transform .12s ease, box-shadow .12s ease;
    }
    .video-row:hover { transform: translateY(-3px); box-shadow: 0 20px 50px rgba(0,0,0,0.7); }

    .video-thumb { position:relative; width:40%; max-width:520px; background:#0a0a0a; overflow:hidden; flex-shrink:0; }
    .video-thumb::before { content:""; display:block; padding-top:56.25%; } /* 16:9 */
    .video-thumb img { position:absolute !important; inset:0; width:100% !important; height:100% !important; object-fit:cover !important; display:block !important; }

    .vid-duration {
      position:absolute; top:10px; right:10px; background: rgba(0,0,0,0.7); padding:5px 8px; font-weight:800; color:var(--text-primary);
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }

    .video-meta { display:flex; flex-direction:column; gap:8px; width:60%; min-width:0; padding:2px 4px; }
    .video-title { font-style: italic; font-weight:800; font-size:16px; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .channel-row { display:flex; align-items:center; gap:8px; }
    .channel-avatar { width:28px; height:28px; overflow:hidden; }
    .channel-avatar img { width:100%; height:100%; object-fit:cover; }
    .channel-title { font-size:12px; font-weight:700; color:var(--text-muted); }

    @media (max-width:700px){
      .video-row { flex-direction:column; padding:10px; }
      .video-thumb { width:100% !important; max-width:100% !important; }
      .video-meta { width:100%; }
      .video-title { font-size:15px; white-space:normal; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      .vid-duration { top:8px; right:8px; padding:4px 6px; font-size:12px; }
    }

    /* ===== Search card & results (updated premium colors) ===== */
    .search-section { margin-top:12px; position:relative; z-index:120; }
    .search-card {
      display:flex; align-items:center; gap:8px; padding:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
      border: 1px solid var(--panel-border);
      box-shadow: 0 12px 36px rgba(0,0,0,0.5);
    }
    .search-input { flex:1; border:0; outline:0; font-size:15px; background:transparent; color:var(--text-primary); padding:6px 2px; }
    .search-results {
      margin-top:8px; background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.5));
      border: 1px solid var(--panel-border); max-height: 52vh; overflow:auto; display:none;
    }
    .search-results.open { display:block; }
    .search-result { display:flex; gap:10px; align-items:center; padding:10px; cursor:pointer; border-bottom: 1px solid rgba(255,255,255,0.02); }
    .sr-thumb { width:56px; height:56px; overflow:hidden; background:#0b0b0b; }
    .sr-thumb img { width:100%; height:100%; object-fit:cover; }
    .sr-name { font-weight:800; font-size:14px; color:var(--text-primary); }

    /* ===== Side menu (ENHANCED) ===== */
    .side-backdrop { position:fixed; inset:0; z-index:200; display:none; background: rgba(0,0,0,0.55); }
    .side-backdrop.open { display:block; }
    /* side-menu upgraded: deeper panel, close button, keyboard trap hint */
    .side-menu {
      position:fixed; left:-100%; top:0; height:100%; width:360px; max-width:92vw;
      background: linear-gradient(180deg, var(--panel-strong), rgba(16,16,16,0.95));
      color: var(--text-primary); z-index:210; padding:18px;
      box-shadow: 40px 0 120px rgba(0,0,0,0.7); border-left: 1px solid rgba(255,255,255,0.02);
      transition: left .26s cubic-bezier(.2,.9,.2,1), transform .26s;
      overflow:auto;
    }
    .side-menu.open { left:0; transform: none; }
    /* close button */
    .side-menu .close-btn {
      width:36px; height:36px; display:inline-grid; place-items:center; background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--text-primary); cursor:pointer; float:right;
    }
    .side-menu h3 { margin:8px 0 14px 0; font-size:18px; font-weight:900; color:var(--accent-gold); letter-spacing:0.01em; }
    .menu-list { display:flex; flex-direction:column; gap:10px; }
    .menu-item {
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px;
      background: rgba(255,255,255,0.01); border: 1px solid rgba(255,255,255,0.02); font-weight:800; cursor:pointer;
      transition: transform .12s ease, background .12s ease; position:relative;
    }
    .menu-item.disabled { opacity:0.55; filter:grayscale(.06); pointer-events:none; }
    .menu-item:focus { outline: 3px solid rgba(212,175,55,0.12); outline-offset:2px; }
    .menu-item::after { content: "›"; color: var(--text-muted); font-weight:900; font-size:16px; opacity:0.9; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .menu-note { color: var(--text-muted); font-size:13px; margin-top:6px; }

    /* close with ESC when menu open */
    .side-menu .kbd-hint { margin-top: 12px; color: var(--text-muted); font-size:13px; }

    /* ===== Floating chat (updated look) ===== */
    .floating-chat {
      position:fixed; right:18px; bottom:18px; z-index:220; width:44px; height:44px; display:grid; place-items:center; cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008)); border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    .floating-chat img { width:28px; height:28px; object-fit:cover; }

    /* ===== Premium modal & Confirm modal improvements ===== */
    .premium-backdrop, .confirm-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:260; background:rgba(0,0,0,0.6); }
    .premium-backdrop.open, .confirm-backdrop.open { display:flex; }
    .premium-card, .confirm-card {
      width:min(540px,92vw); background: linear-gradient(180deg, #fff, #fbfbfb); color:#111; padding:18px; box-shadow: 0 40px 120px rgba(0,0,0,0.6);
      border: 1px solid rgba(0,0,0,0.06);
    }
    .premium-card .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:18px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(0,0,0,0.06); padding:10px 12px; font-weight:800; cursor:pointer; }
    .btn-primary { background: linear-gradient(180deg, var(--accent-gold), var(--accent-gold-strong)); color:#111; padding:10px 12px; font-weight:900; border:0; cursor:pointer; }

    /* focus ring improvement for keyboard users globally */
    :focus { outline: 3px solid rgba(143,214,255,0.08); outline-offset: 2px; }

    /* small helpers */
    .muted { color: var(--text-muted); }
    a.glass-link { color: var(--link); font-weight:700; text-decoration:none; }
    a.glass-link:hover { text-decoration: underline; }

    /* ————————————————
   ROUND CHANNEL LOGO + CHAT ICON
——————————————— */
.channel-avatar img,
.floating-chat img {
    border-radius: 50% !important;
}

/* ————————————————
   REMOVE OUTLINE FROM 3-DOT MENU & MODAL
——————————————— */
.side-menu,
.side-menu *,
.menu-item,
.side-menu .close-btn,
.side-menu:focus,
.side-menu *:focus,
.side-backdrop,
.menu-item:focus,
.menu-item:hover,
.side-menu h3,
.side-menu .ref-text {
    outline: none !important;
    box-shadow: none !important;
    border-color: rgba(255,255,255,0.02) !important;
}

/* Remove ESC text completely */
.kbd-hint { display:none !important; }

    /* Make floating chat button fully circular — 30% smaller */
.floating-chat {
    border-radius: 50% !important;
    width: 40px !important;
    height: 40px !important;
    padding: 0 !important;
    overflow: hidden !important;
}

/* Ensure icon fits clean & centered */
.floating-chat img {
    border-radius: 50% !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}
    /* Remove focus glow/blue highlight from search box */
.search-input,
.search-input:focus,
.search-card:focus-within,
input:focus,
textarea:focus {
    outline: none !important;
    box-shadow: none !important;
    border: none !important;
}
    .search-card {
    outline: none !important;
    box-shadow: none !important;
    }
    /* =========================
   HIGHLIGHTS — RESPONSIVE WIDTH
   ========================= */

/* PC/tablet = 5 cards visible */
.hl-item {
    flex: 0 0 calc((100% / 5) - 12px) !important;
    max-width: calc((100% / 5) - 12px) !important;
    aspect-ratio: 16/9;
}

/* Mobile = 2.5 cards visible (peek next card) */
@media (max-width: 700px){
  .hl-item {
      flex: 0 0 calc((100% / 2.5) - 10px) !important;
      max-width: calc((100% / 2.5) - 10px) !important;
      aspect-ratio: 16/9;
  }
}
  </style>
</head>
<body>
  <main class="page" id="app">
    <header class="header" role="banner" aria-label="Community header">
      <div class="brand">
        <div class="title">Community</div>
      </div>

      <div class="hdr-actions" aria-hidden="false" role="toolbar" aria-label="Header actions">
        <button id="uploadBtn" class="icon-btn" title="Upload" aria-label="Upload"><i data-lucide="upload"></i></button>
        <button id="openMenuBtn" class="icon-btn" title="Menu" aria-label="Open menu"><i data-lucide="menu"></i></button>
      </div>
    </header>

    <!-- Highlights -->
    <section class="highlights" aria-label="Highlights">
      <div id="hlViewport" class="hl-viewport" tabindex="0" aria-label="Highlights carousel">
        <div id="hlInner" class="hl-inner" aria-live="polite"></div>
      </div>
    </section>

    <!-- Search -->
    <section class="search-section" id="searchSection" aria-label="Search videos">
      <div class="search-card" role="search" aria-label="Search videos">
        <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true" width="18" height="18"><path fill="currentColor" d="M21.53 20.47l-4.82-4.82A7.92 7.92 0 0018 10a8 8 0 10-8 8 7.92 7.92 0 005.65-1.29l4.82 4.82a.75.75 0 001.06-1.06zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"/></svg>
        <input id="searchInput" class="search-input" placeholder="Search videos or tags..." autocomplete="off" aria-label="Search videos" />
      </div>
      <div id="searchResults" class="search-results" role="listbox" aria-live="polite"></div>
    </section>

    <div class="layout" role="main">
      <div class="content">
        <section id="videoList" class="video-list" aria-live="polite"></section>
     </div>

      <aside class="sidebar" aria-label="Sidebar">
        <!-- Sidebar intentionally left minimal per request -->
      </aside>
    </div>
  </main>

  <!-- Side menu (enhanced) -->
  <div id="sideBackdrop" class="side-backdrop" aria-hidden="true"></div>
  <aside id="sideMenu" class="side-menu" role="dialog" aria-modal="true" aria-label="Main menu" tabindex="-1">
    <button class="close-btn" id="sideClose" title="Close menu" aria-label="Close menu"><i data-lucide="x"></i></button>
    <h3>Menu</h3>

    <div id="menuProfileArea"></div>

    <div class="menu-list" id="menuList" role="menu" aria-label="Menu items">
      <div id="mi_signin" class="menu-item" role="menuitem" tabindex="0">
        <div>
          <div>Sign in with Google</div>
          <div class="menu-note">Sign in once to access Chat & Showcase</div>
        </div>
        <div class="ref-text">GO</div>
      </div>

      <div id="mi_signout" class="menu-item" role="menuitem" tabindex="0" style="display:none;">
        <div>
          <div>Sign out</div>
          <div class="menu-note">Sign out from your account</div>
        </div>
        <div>OUT</div>
      </div>

      <div id="mi_chat" class="menu-item disabled" role="menuitem" tabindex="0">
        <div>
          <div>Community Chat</div>
          <div class="menu-note">Enter live rooms</div>
        </div>
        <div class="ref-text">OPEN</div>
      </div>

      <div id="mi_showcase" class="menu-item disabled" role="menuitem" tabindex="0">
        <div>
          <div>Showcase</div>
          <div class="menu-note">Upload or browse shared works</div>
        </div>
        <div class="ref-text">OPEN</div>
      </div>

      <div id="mi_support" class="menu-item" role="menuitem" tabindex="0">
        <div>
          <div>Customer Support</div>
          <div class="menu-note">Contact support or open help docs</div>
        </div>
        <div>HELP</div>
      </div>

      <div id="mi_privacy" class="menu-item" role="menuitem" tabindex="0">
        <div>
          <div>Privacy Policy</div>
          <div class="menu-note">Read our privacy policy</div>
        </div>
        <div>VIEW</div>
      </div>

      <div id="mi_guidelines" class="menu-item" role="menuitem" tabindex="0">
        <div>
          <div>Community Guidelines</div>
          <div class="menu-note">Rules & best practices</div>
        </div>
        <div>READ</div>
      </div>

      <div class="kbd-hint muted" aria-hidden="true">Press ESC to close</div>
    </div>
  </aside>

  <!-- Floating chat -->
  <div id="floatingChat" class="floating-chat" title="Open community chat" aria-label="Open community chat">
    <img id="floatingChatImg" src="https://raw.githubusercontent.com/Moneythepro/TicTacToe/main/assets/floating.png" alt="chat" onerror="this.src='https://raw.githubusercontent.com/Moneythepro/TicTacToe/main/assets/channel-default.png'"/>
  </div>

  <!-- Premium modal -->
  <div id="premiumBackdrop" class="premium-backdrop" aria-hidden="true">
    <div class="premium-card" role="dialog" aria-modal="true" aria-label="Sign in required">
      <div style="font-weight:900;font-size:18px;color:var(--accent-gold)">Sign in required</div>
      <div style="margin-top:12px;color:#444">You must sign in to access Community Chat and Upload features. Sign in with Google to continue.</div>
      <div class="actions">
        <button id="premiumClose" class="btn-ghost" aria-label="Close">Close</button>
        <button id="premiumSignIn" class="btn-primary" aria-label="Sign in with Google">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Confirm logout modal -->
  <div id="confirmBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="confirm-card" role="dialog" aria-modal="true" aria-label="Confirm sign out">
      <div style="font-weight:900;font-size:16px">Confirm sign out</div>
      <div style="margin-top:8px;color:#666">Are you sure you want to sign out?</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
        <button id="cancelLogoutBtn" class="btn-ghost">Cancel</button>
        <button id="confirmLogoutBtn" class="btn-primary">Sign out</button>
      </div>
    </div>
  </div>

  <!-- Inline fallback SVGs -->
  <template id="svgFallback">
    <svg id="svg-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    <svg id="svg-upload" viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
  </template>

  <!-- Existing script from your original file with improvements left intact; minimal changes below -->
  <script>
  (function () {
    /* -------------------------
       CONFIG (unchanged)
    ------------------------- */
    const API_KEY = 'AIzaSyA97DNGHIF85wLeIlDndNtOWTA6BofbJ0A';
    const GH_RAW_BASE = 'https://raw.githubusercontent.com/Moneythepro/BoombaeGameStore/main/assets';
    const firebaseConfig = {
      apiKey: "AIzaSyCPVer1Qg4ecHxbUKHUst8C0dyPCm8LEkM",
      authDomain: "community-7bd8d.firebaseapp.com",
      projectId: "community-7bd8d",
      storageBucket: "community-7bd8d.firebasestorage.app",
      messagingSenderId: "1034615155630",
      appId: "1:1034615155630:web:e4ee92c96c3a04875f363f",
      measurementId: "G-BW2QDBG8GC"
    };

    /* -------------------------
       DOM refs
    ------------------------- */
    const $ = id => document.getElementById(id);
    let sideBackdropEl, sideMenuEl, openMenuBtnEl, uploadBtnEl, menuProfileAreaEl;
    let mi_signin_el, mi_signout_el, mi_chat_el, mi_showcase_el, mi_support_el, mi_privacy_el, mi_guidelines_el;
    let hlViewportEl, hlInnerEl, videoListEl;
    let floatingChatEl, premiumBackdropEl, premiumSignInBtn, premiumCloseBtn;
    let searchInputEl, searchResultsEl, floatingChatImg;
    let menuListEl;
    let sideCloseBtn;

    /* -------------------------
       Firebase handles
    ------------------------- */
    let auth = null;
    let db = null;
    let currentUser = null;

    /* -------------------------
       Local video cache
    ------------------------- */
    let videoCache = [];

    /* Demo fallback videos kept */
    const DEMO_VIDEOS = [
      { videoId: 'dQw4w9WgXcQ', title: 'Demo Intro', tags: [] },
      { videoId: 'M7lc1UVf-VE', title: 'Demo Tutorial', tags: [] },
      { videoId: 'sNPnbI1arSE', title: 'Demo Showcase', tags: [] },
      { videoId: 'kXYiU_JCYi', title: 'Demo Interview', tags: [] },
      { videoId: '3JZ_D3ELwOQ', title: 'Demo Design', tags: [] },
      { videoId: 'e-ORhEE9VVg', title: 'Demo Short', tags: [] }
    ];

    /* -------------------------
       Icon init
    ------------------------- */
    function initIcons(attempts = 10, delay = 60) {
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        try { window.lucide.createIcons({ className: 'lucide' }); } catch(e){ mountFallbackIcons(); }
        return;
      }
      if (attempts <= 0) { mountFallbackIcons(); return; }
      setTimeout(() => initIcons(attempts - 1, delay), delay);
    }
    function mountFallbackIcons(){
      const tpl = $('svgFallback'); if (!tpl) return;
      const map = {}; Array.from(tpl.content.children).forEach(svg => map[svg.id.replace(/^svg-/,'')] = svg.outerHTML);
      document.querySelectorAll('.icon-placeholder').forEach(el => {
        const name = el.getAttribute('data-icon') || 'menu';
        el.outerHTML = map[name] || map['menu'] || '<svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="currentColor"/></svg>';
      });
    }

    /* -------------------------
       Firebase: optional init
    ------------------------- */
    function tryInitFirebase(){
      try {
        if (typeof firebase !== 'undefined' && firebase && firebase.initializeApp) {
          try { firebase.initializeApp(firebaseConfig); } catch (e) { /* ignore already inited */ }
          if (firebase.auth) auth = firebase.auth();
          if (firebase.firestore) db = firebase.firestore();
        }
      } catch (e) { console.warn('Firebase init failed', e); auth = null; db = null; }
    }

    /* -------------------------
       YouTube helpers (kept from original)
    ------------------------- */
    async function fetchVideoDetailsBatch(videoIds) {
      if (!API_KEY) return {};
      const ids = Array.from(new Set(videoIds.filter(Boolean))).join(',');
      if (!ids) return {};
      try {
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${encodeURIComponent(ids)}&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('videos.list failed');
        const json = await res.json();
        const out = {};
        if (Array.isArray(json.items)) { json.items.forEach(it => { out[it.id] = it; }); }
        return out;
      } catch (e) { console.warn('fetchVideoDetailsBatch error', e); return {}; }
    }

    const channelCache = {};
    async function fetchChannelInfo(channelIds) {
      const ids = Array.from(new Set(channelIds.filter(Boolean)));
      const missing = ids.filter(id => !channelCache[id]);
      if (missing.length === 0) { const pick = {}; ids.forEach(id => pick[id] = channelCache[id]); return pick; }
      try {
        const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${encodeURIComponent(missing.join(','))}&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('channels.list failed');
        const json = await res.json();
        if (Array.isArray(json.items)) {
          json.items.forEach(ch => {
            channelCache[ch.id] = {
              title: ch.snippet?.title || '',
              thumbnail: ch.snippet?.thumbnails?.default?.url || ch.snippet?.thumbnails?.medium?.url || ch.snippet?.thumbnails?.high?.url || ''
            };
          });
        }
      } catch (e) { console.warn('fetchChannelInfo error', e); }
      const pick = {}; ids.forEach(id => pick[id] = channelCache[id] || { title: '', thumbnail: '' });
      return pick;
    }

    async function fetchOEmbedTitle(id){
      if (!id) return '';
      try {
        const r = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
        if (!r.ok) throw new Error('oembed failed');
        const j = await r.json();
        return (j.title || '').trim();
      } catch (e) { return ''; }
    }

    function iso8601ToTime(iso) {
      if (!iso) return '';
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!m) return '';
      const hours = parseInt(m[1] || 0, 10);
      const minutes = parseInt(m[2] || 0, 10);
      const seconds = parseInt(m[3] || 0, 10);
      const pad = (n) => (n < 10 ? '0' + n : String(n));
      if (hours > 0) { return `${hours}:${pad(minutes)}:${pad(seconds)}`; } else { return `${minutes}:${pad(seconds)}`; }
    }

    /* -------------------------
       Load videos (keeps randomization & real-only logic)
    ------------------------- */
    async function loadVideos(){
      let list = [];
      if (db) {
        try {
          const snap = await db.collection('community_videos').get();
          snap.forEach(doc => {
            const d = doc.data();
            const id = extractYouTubeID(d.videoId || d.youtube || d.link || '');
            if (!id) return;
            // only include real-ish items (require title or videoId)
            const title = d.title ? String(d.title).trim() : '';
            list.push({ videoId: id, title: title, tags: d.tags || [], category: d.category || '' });
          });
        } catch (e) { console.warn('Firestore read failed', e); list = []; }
      }

      if (!list.length) {
        try {
          const raw = localStorage.getItem('community_videos');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed) && parsed.length) {
              list = parsed.map(p => ({ videoId: extractYouTubeID(p.videoId||p.id||''), title: p.title ? String(p.title).trim() : '', tags: p.tags || [] }));
            }
          }
        } catch(e){}
      }

      if (!list.length) {
        list = DEMO_VIDEOS.map(d => ({ videoId: d.videoId, title: d.title || 'Intro', tags: d.tags || [] }));
      }

      const needs = list.filter(v => !v.title && v.videoId).slice(0,8);
      await Promise.all(needs.map(async v => { const t = await fetchOEmbedTitle(v.videoId); if (t) v.title = t; }));

      list.forEach(v => { if (!v.title) v.title = 'Untitled'; });

      const ids = list.map(v => v.videoId).filter(Boolean);
      if (ids.length && API_KEY) {
        const chunks = [];
        for (let i=0;i<ids.length;i+=50) chunks.push(ids.slice(i, i+50));
        const vidMap = {};
        for (const chunk of chunks) {
          const details = await fetchVideoDetailsBatch(chunk);
          Object.assign(vidMap, details);
        }
        const channelIds = [];
        list.forEach(v => {
          const info = vidMap[v.videoId];
          if (info && info.snippet) {
            v.title = info.snippet.title || v.title;
            v.channelId = info.snippet.channelId || '';
            v.channelTitle = info.snippet.channelTitle || '';
          }
          if (info && info.contentDetails) { v.duration = iso8601ToTime(info.contentDetails.duration || ''); } else { v.duration = ''; }
          if (v.channelId) channelIds.push(v.channelId);
        });
        if (channelIds.length) {
          const chMap = await fetchChannelInfo(channelIds);
          list.forEach(v => {
            if (v.channelId && chMap[v.channelId]) {
              v.channelAvatar = chMap[v.channelId].thumbnail || `${GH_RAW_BASE}/channel-default.png`;
              v.channelTitle = v.channelTitle || chMap[v.channelId].title || '';
            } else { v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`; }
          });
        } else { list.forEach(v => { v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`; v.duration = ''; }); }
      } else { list.forEach(v => { v.channelAvatar = `${GH_RAW_BASE}/channel-default.png`; v.duration = v.duration || ''; }); }

      // shuffle so recommendations & list vary on reload (real-only)
      for (let i = list.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [list[i], list[j]] = [list[j], list[i]];
      }

      return list;
    }

    function extractYouTubeID(input){
      if (!input) return '';
      if (/^[A-Za-z0-9_-]{11}$/.test(input)) return input;
      const m = input.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      const mm = input.match(/([A-Za-z0-9_-]{11})/);
      return mm ? mm[1] : '';
    }

    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /* -------------------------
       DOM builders
    ------------------------- */
    function buildHighlightNode(item){
      const a = document.createElement('a');
      a.className = 'hl-item';
      a.href = `video_player.html?vid=${encodeURIComponent(item.videoId)}`;
      a.setAttribute('aria-label', item.title || 'highlight');
      a.tabIndex = 0;
      const img = document.createElement('img');
      img.loading = 'lazy'; img.alt = item.title || 'thumbnail';
      img.src = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      img.onerror = () => { if (!img.dataset.err){ img.dataset.err='1'; img.src = `https://i.ytimg.com/vi/${item.videoId}/mqdefault.jpg`; } };
      const cap = document.createElement('div'); cap.className = 'hl-caption'; cap.textContent = item.title || '';
      a.appendChild(img); a.appendChild(cap);
      return a;
    }

    function buildVideoRow(item){
      const row = document.createElement('article');
      row.className = 'video-row'; row.tabIndex = 0;
      row.onclick = () => { window.location.href = `video_player.html?vid=${encodeURIComponent(item.videoId)}`; };
      row.onkeypress = (e) => { if (e.key === 'Enter') row.onclick(); };

      const thumb = document.createElement('div'); thumb.className = 'video-thumb';
      const img = document.createElement('img'); img.loading = 'lazy'; img.alt = item.title || 'thumbnail';
      img.src = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      img.onerror = () => { if (!img.dataset.err){ img.dataset.err='1'; img.src = `https://i.ytimg.com/vi/${item.videoId}/mqdefault.jpg`; } };
      thumb.appendChild(img);

      const dur = document.createElement('div'); dur.className = 'vid-duration'; dur.textContent = item.duration || '';
      if (item.duration) thumb.appendChild(dur);

      const meta = document.createElement('div'); meta.className = 'video-meta';
      const title = document.createElement('div'); title.className = 'video-title'; title.textContent = item.title || 'Untitled';
      const channelRow = document.createElement('div'); channelRow.className = 'channel-row';
      const chAvatar = document.createElement('div'); chAvatar.className = 'channel-avatar';
      const chImg = document.createElement('img'); chImg.alt = item.channelTitle || 'channel';
      chImg.src = item.channelAvatar || `${GH_RAW_BASE}/channel-default.png`;
      chImg.onerror = () => { if (!chImg.dataset.err){ chImg.dataset.err='1'; chImg.src = `${GH_RAW_BASE}/channel-default.png`; } };
      chAvatar.appendChild(chImg);
      const chTitle = document.createElement('div'); chTitle.className = 'channel-title'; chTitle.textContent = item.channelTitle || '';
      channelRow.appendChild(chAvatar); channelRow.appendChild(chTitle);
      meta.appendChild(title); meta.appendChild(channelRow);

      row.appendChild(thumb); row.appendChild(meta);
      return row;
    }

    /* -------------------------
       Renderers + auto highlight scroll
    ------------------------- */
    function renderHighlights(list){
      const pool = list.slice();
      for (let i = pool.length - 1; i > 0; i--){ const j = Math.floor(Math.random() * (i + 1)); [pool[i], pool[j]] = [pool[j], pool[i]]; }
      const picks = pool.slice(0, Math.min(pool.length, 6));
      hlInnerEl.innerHTML = '';
      picks.forEach(p => hlInnerEl.appendChild(buildHighlightNode(p)));
      picks.forEach(p => hlInnerEl.appendChild(buildHighlightNode(p))); // duplicate for smooth loop
      hlViewportEl.scrollLeft = 0;
    }

    function renderVideoList(list){
      const arr = list.slice();
      for (let i = arr.length - 1; i > 0; i--){ const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
      videoListEl.innerHTML = '';
      arr.forEach(v => videoListEl.appendChild(buildVideoRow(v)));
    }

    let autoTimer = null;
    function startAuto(){ if (autoTimer) return; const speed = 0.36; autoTimer = setInterval(()=>{ hlViewportEl.scrollLeft += speed; const half = hlInnerEl.scrollWidth/2 || 0; if (half && hlViewportEl.scrollLeft >= half){ hlViewportEl.scrollLeft = hlViewportEl.scrollLeft - half; } }, 16); }
    function stopAuto(){ if (autoTimer){ clearInterval(autoTimer); autoTimer = null; } }

    /* -------------------------
       Menu & UI wiring
    ------------------------- */
    function openSideMenu(){ sideBackdropEl.classList.add('open'); sideBackdropEl.setAttribute('aria-hidden','false'); sideMenuEl.classList.add('open'); sideMenuEl.setAttribute('aria-hidden','false'); sideMenuEl.focus(); }
    function closeSideMenu(){ sideMenuEl.classList.remove('open'); sideBackdropEl.classList.remove('open'); sideBackdropEl.setAttribute('aria-hidden','true'); sideMenuEl.setAttribute('aria-hidden','true'); }

    function setMenuEnabled(el, enabled){ if (!el) return; if (enabled) el.classList.remove('disabled'); else el.classList.add('disabled'); }

    async function doGoogleSignIn(){
      if (!auth){
        menuProfileAreaEl.innerHTML = `<div style="color:#333">Google sign-in isn't configured in this environment.</div>`;
        return;
      }
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const res = await auth.signInWithPopup(provider);
        currentUser = res.user;
        updateUIForAuth(currentUser);
        closeSideMenu();
      } catch (err) { console.error('Sign-in failed', err); menuProfileAreaEl.innerHTML = `<div style="color:#333">Sign-in failed (popup blocked or configuration issue).</div>`; }
    }

    function openConfirmLogout(){ $('confirmBackdrop').classList.add('open'); $('confirmBackdrop').setAttribute('aria-hidden','false'); }
    function closeConfirmLogout(){ $('confirmBackdrop').classList.remove('open'); $('confirmBackdrop').setAttribute('aria-hidden','true'); }

    async function confirmAndSignOut(){
      if (!auth){ currentUser = null; updateUIForAuth(null); closeConfirmLogout(); closeSideMenu(); return; }
      try { await auth.signOut(); currentUser = null; updateUIForAuth(null); closeConfirmLogout(); closeSideMenu(); } catch (e) { console.error('Sign-out failed', e); menuProfileAreaEl.innerHTML = `<div style="color:#333">Unable to sign out. Try again.</div>`; }
    }

    function updateUIForAuth(user){
      currentUser = user;
      const logged = !!user;
      if (mi_signin_el) mi_signin_el.style.display = logged ? 'none' : '';
      if (mi_signout_el) mi_signout_el.style.display = logged ? '' : 'none';
      setMenuEnabled(mi_chat_el, logged);
      setMenuEnabled(mi_showcase_el, logged);

      menuProfileAreaEl.innerHTML = '';
      if (logged){
        menuProfileAreaEl.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${escapeHtml(user.photoURL || (GH_RAW_BASE + '/channel-default.png'))}" style="width:56px;height:56px;border-radius:0;border:2px solid rgba(0,0,0,0.06)" alt="profile" />
            <div>
              <div style="font-weight:800">${escapeHtml(user.displayName || '')}</div>
              <div style="color:#666;font-size:13px">${escapeHtml(user.email || '')}</div>
            </div>
          </div>
        `;
      } else {
        menuProfileAreaEl.innerHTML = `<div style="font-weight:800;color:#111">Welcome</div><div class="menu-note">Sign in to unlock Chat & Showcase.</div>`;
      }
    }

    function openPremiumModal(){ premiumBackdropEl.classList.add('open'); premiumBackdropEl.setAttribute('aria-hidden','false'); }
    function closePremiumModal(){ premiumBackdropEl.classList.remove('open'); premiumBackdropEl.setAttribute('aria-hidden','true'); }

    function debounce(fn, ms=180){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    let searchSelectedIndex = -1;
    function escapeRegExp(s){ return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); }
    function highlightMatch(text, query){
      if (!query) return text;
      try { const re = new RegExp('('+escapeRegExp(query)+')','ig'); return text.replace(re, '<mark style="background:transparent;color:var(--accent-gold);font-weight:900">$1</mark>'); } catch(e){ return text; }
    }

    function createSearchResultNode(p, idx, term){
      const a = document.createElement('div');
      a.className = 'search-result'; a.tabIndex = 0; a.setAttribute('data-index', idx);
      const thumb = document.createElement('div'); thumb.className = 'sr-thumb';
      const timg = document.createElement('img'); timg.src = `https://i.ytimg.com/vi/${p.videoId}/hqdefault.jpg`; timg.alt = p.title || ''; thumb.appendChild(timg);
      const meta = document.createElement('div');
      const name = document.createElement('div'); name.className = 'sr-name'; name.innerHTML = highlightMatch(escapeHtml(p.title || ''), term);
      const ch = document.createElement('div'); ch.className = 'sr-channel'; ch.textContent = p.channelTitle || '';
      meta.appendChild(name); meta.appendChild(ch);
      a.appendChild(thumb); a.appendChild(meta);
      a.addEventListener('click', () => { window.location.href = `video_player.html?vid=${encodeURIComponent(p.videoId)}`; });
      return a;
    }

    const doSearch = debounce((q) => {
      if (!searchResultsEl) return;
      searchResultsEl.classList.remove('open'); searchResultsEl.innerHTML = ''; searchSelectedIndex = -1;
      const term = String(q || '').trim();
      if (!term) return;
      const lterm = term.toLowerCase();
      const scored = videoCache.map(p => {
        const name = (p.title || '').toLowerCase();
        const tags = (p.tags || []).map(t => String(t).toLowerCase()).join(' ');
        let score = 0;
        if (name === lterm) score += 300;
        if (name.startsWith(lterm)) score += 160;
        if (name.includes(lterm)) score += 100;
        if (tags.includes(lterm)) score += 60;
        const tokens = name.split(/\s+/);
        tokens.forEach(tok => { if (tok.startsWith(lterm)) score += 15; if (tok.includes(lterm)) score += 6; });
        if (score === 0){ const overlap = simpleOverlapScore(name, lterm); score += overlap; }
        return { p, score };
      }).filter(x => x.score > 0).sort((a,b) => b.score - a.score).slice(0, 18);

      if (!scored.length){ searchResultsEl.innerHTML = '<div style="padding:14px;color:#999">No results</div>'; searchResultsEl.classList.add('open'); return; }

      scored.forEach((s, idx) => { const node = createSearchResultNode(s.p, idx, term); searchResultsEl.appendChild(node); });
      searchResultsEl.classList.add('open');
    }, 160);

    function simpleOverlapScore(a,b){
      if (!a || !b) return 0;
      let score = 0;
      const setA = new Set(a.split('').filter(Boolean));
      for (const ch of b.split('')) if (setA.has(ch)) score += 1;
      return Math.min(40, score);
    }

    function updateSearchSelection(items){
      items.forEach((it, i) => {
        if (i === searchSelectedIndex){ it.classList.add('selected'); it.scrollIntoView({block:'nearest', behavior:'smooth'}); }
        else { it.classList.remove('selected'); }
      });
    }

    function wireSearchKeyboard(){
      searchInputEl.addEventListener('keydown', (ev) => {
        const items = Array.from(searchResultsEl.querySelectorAll('.search-result'));
        if (ev.key === 'ArrowDown'){ ev.preventDefault(); if (!items.length) return; searchSelectedIndex = Math.min(items.length - 1, searchSelectedIndex + 1); updateSearchSelection(items); }
        else if (ev.key === 'ArrowUp'){ ev.preventDefault(); if (!items.length) return; searchSelectedIndex = Math.max(0, searchSelectedIndex - 1); updateSearchSelection(items); }
        else if (ev.key === 'Enter'){ const sel = items[searchSelectedIndex]; if (sel) sel.click(); }
        else if (ev.key === 'Escape'){ searchInputEl.value = ''; doSearch(''); searchInputEl.blur(); }
      });
    }

    /* -------------------------
       UI wiring
    ------------------------- */
    function wireUI(){
      openMenuBtnEl.addEventListener('click', (e) => { e.stopPropagation(); openSideMenu(); });
      sideBackdropEl.addEventListener('click', (e) => { if (e.target === sideBackdropEl) closeSideMenu(); });
      sideCloseBtn.addEventListener('click', () => closeSideMenu());
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape'){ closeSideMenu(); closePremiumModal(); closeConfirmLogout(); } });

      try { mi_signin_el.addEventListener('click', () => { if (mi_signin_el.classList.contains('disabled')) return; doGoogleSignIn(); }); } catch(e){}
      try { mi_signout_el.addEventListener('click', () => { if (mi_signout_el.classList.contains('disabled')) return; openConfirmLogout(); }); } catch(e){}
      try { mi_chat_el.addEventListener('click', () => { if (mi_chat_el.classList.contains('disabled')) { openPremiumModal(); return; } window.location.href = 'community_chat.html'; }); } catch(e){}
      try { mi_showcase_el.addEventListener('click', () => { if (mi_showcase_el.classList.contains('disabled')) { openPremiumModal(); return; } window.location.href = 'showcase.html'; }); } catch(e){}
      try { mi_support_el.addEventListener('click', () => { window.location.href = 'support.html'; }); } catch(e){}
      try { mi_privacy_el.addEventListener('click', () => { window.location.href = 'pp.html'; }); } catch(e){}
      try { mi_guidelines_el.addEventListener('click', () => { window.location.href = 'community_guidelines.html'; }); } catch(e){}

      uploadBtnEl.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!currentUser) { openPremiumModal(); return; }
        window.location.href = 'showcase.html';
      });

      floatingChatEl.addEventListener('click', () => {
        if (!currentUser) { openPremiumModal(); return; }
        window.location.href = 'community_chat.html';
      });

      premiumSignInBtn.addEventListener('click', () => { closePremiumModal(); doGoogleSignIn(); });
      premiumCloseBtn.addEventListener('click', () => closePremiumModal());
      premiumBackdropEl.addEventListener('click', (e) => { if (e.target === premiumBackdropEl) closePremiumModal(); });

      try { $('confirmLogoutBtn') && $('confirmLogoutBtn').addEventListener('click', () => confirmAndSignOut()); } catch(e){}
      try { $('cancelLogoutBtn') && $('cancelLogoutBtn').addEventListener('click', () => closeConfirmLogout()); } catch(e){}
      try { $('confirmBackdrop') && $('confirmBackdrop').addEventListener('click', (e) => { if (e.target === $('confirmBackdrop')) closeConfirmLogout(); }); } catch(e){}

      searchInputEl.addEventListener('input', (e) => doSearch(e.target.value));
      wireSearchKeyboard();

      document.addEventListener('click', (e) => { if (!searchResultsEl.contains(e.target) && e.target !== searchInputEl) searchResultsEl.classList.remove('open'); });

      // menu delegation
      if (menuListEl) {
        menuListEl.addEventListener('click', (ev) => {
          const row = ev.target.closest('.menu-item'); if (!row) return;
          const id = row.id;
          if (id === 'mi_signin') { if (row.classList.contains('disabled')) return; doGoogleSignIn(); }
          else if (id === 'mi_signout') { if (row.classList.contains('disabled')) return; openConfirmLogout(); }
          else if (id === 'mi_chat') { if (row.classList.contains('disabled')) { openPremiumModal(); return; } window.location.href = 'community_chat.html'; }
          else if (id === 'mi_showcase') { if (row.classList.contains('disabled')) { openPremiumModal(); return; } window.location.href = 'showcase.html'; }
          else if (id === 'mi_support') { window.location.href = 'support.html'; }
          else if (id === 'mi_privacy') { window.location.href = 'pp.html'; }
          else if (id === 'mi_guidelines') { window.location.href = 'community_guidelines.html'; }
        });

        menuListEl.addEventListener('keydown', (ev) => {
          if (ev.key !== 'Enter' && ev.key !== ' ') return;
          const row = ev.target.closest('.menu-item') || document.activeElement.closest('.menu-item');
          if (!row) return;
          ev.preventDefault(); row.click();
        });
      }
    }

    /* -------------------------
       Boot sequence
    ------------------------- */
    async function boot(){
      sideBackdropEl = $('sideBackdrop'); sideMenuEl = $('sideMenu'); openMenuBtnEl = $('openMenuBtn');
      uploadBtnEl = $('uploadBtn'); menuProfileAreaEl = $('menuProfileArea');
      mi_signin_el = $('mi_signin'); mi_signout_el = $('mi_signout'); mi_chat_el = $('mi_chat'); mi_showcase_el = $('mi_showcase');
      mi_support_el = $('mi_support'); mi_privacy_el = $('mi_privacy'); mi_guidelines_el = $('mi_guidelines');
      hlViewportEl = $('hlViewport'); hlInnerEl = $('hlInner'); videoListEl = $('videoList');
      floatingChatEl = $('floatingChat'); floatingChatImg = $('floatingChatImg'); premiumBackdropEl = $('premiumBackdrop');
      premiumSignInBtn = $('premiumSignIn'); premiumCloseBtn = $('premiumClose'); searchInputEl = $('searchInput');
      searchResultsEl = $('searchResults'); menuListEl = $('menuList'); sideCloseBtn = $('sideClose');

      try { if (uploadBtnEl) uploadBtnEl.innerHTML = '<i data-lucide="upload"></i>'; if (openMenuBtnEl) openMenuBtnEl.innerHTML = '<i data-lucide="menu"></i>'; } catch (e) {}
      initIcons();
      tryInitFirebase();

      setMenuEnabled(mi_signin_el, true);
      mi_signout_el && mi_signout_el.classList.remove("disabled");
      setMenuEnabled(mi_chat_el, false);
      setMenuEnabled(mi_showcase_el, false);
      if (mi_signout_el) mi_signout_el.style.display = 'none';

      wireUI();

      // Load videos and render
      const videos = await loadVideos();
      videoCache = videos.map(v => ({ videoId: v.videoId, title: v.title, category: v.category, tags: v.tags || [], channelAvatar: v.channelAvatar || (GH_RAW_BASE + '/channel-default.png'), channelTitle: v.channelTitle || '', duration: v.duration || '' }));

      // patch missing titles (non-blocking)
      videos.forEach(async v => { if ((!v.title || v.title === 'Untitled') && v.videoId) { const t = await fetchOEmbedTitle(v.videoId); if (t && t.length) v.title = t; } });

      renderHighlights(videos); renderVideoList(videos); startAuto();

      if (auth) {
        auth.onAuthStateChanged(u => { currentUser = u; updateUIForAuth(u); });
      } else {
        if (menuProfileAreaEl) menuProfileAreaEl.innerHTML = `<div style="color:#333">Auth not configured in this environment. Sign-in will be unavailable.</div>`;
      }

      // tips toggle
      const tipsToggle = $('tipsToggle'); const tipsBody = $('tipsBody');
      if (tipsToggle && tipsBody) {
        tipsToggle.addEventListener('click', ()=> {
          const open = tipsBody.classList.toggle('open');
          tipsToggle.setAttribute('aria-expanded', String(open));
          // rotate icon a bit (use lucide re-creation)
          try { window.lucide && window.lucide.createIcons(); } catch(e){}
        });
      }

      // trap focus in side menu while open for keyboard users
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Tab' && sideMenuEl.classList.contains('open')) {
          const focusable = sideMenuEl.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"]), .menu-item');
          if (!focusable.length) return;
          const first = focusable[0], last = focusable[focusable.length-1];
          if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      });

      window.CommunityUI = { boot, startAuto, stopAuto };
      console.info('Community UI boot complete — updated build');
    }

    document.addEventListener('DOMContentLoaded', boot);
  })();
  </script>

  <script>
    // ensure lucide icons render after load
    window.addEventListener('load', () => {
      try { if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons({ className: 'lucide' }); } catch(e){ console.warn('lucide error', e); }
    });
  </script>
</body>
</html>
