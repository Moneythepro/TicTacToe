<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Community — Video Player</title>

  <!-- Fonts & Lucide icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>

  <!-- Firebase compat (used for Firestore community_videos collection) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <meta name="theme-color" content="#000000" />

  <style>
    /* =============================
       Boombae — Community Video Player
       - Dark-only
       - Square corners everywhere
       - Fixed, full-bleed 16:9 player at very top (touching edges)
       - All UI panels: glass black (square)
       - Background images (non-scrolling) for portrait/landscape:
         sp-vertical.png and sp-horizontal.png
       - Recommendations: ONLY Firestore 'community_videos' (random)
       ============================= */

    :root{
      --black: #000000;
      --panel-glass: rgba(0,0,0,0.60); /* glass black */
      --panel-border: rgba(255,255,255,0.04);
      --muted: #9aa0a6;
      --accent: #ff3b30;
      --maxw: 1200px;
      --gap: 12px;
    }

    /* Force square corners everywhere */
    * { box-sizing: border-box; border-radius: 0 !important; }

    html,body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--black);
      color:#fff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
      -ms-text-size-adjust:100%;
    }

    /* Fixed full-screen background images (non-scrollable) */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: 0;
      background-position: center center;
      background-size: cover;
      background-repeat: no-repeat;
      pointer-events: none;
      /* fallback color if images missing */
      background-color: #000;
      filter: none;
      opacity: 1;
    }
    /* portrait -> vertical image */
    @media (orientation: portrait) {
      body::before { background-image: url('sp-vertical.png'); }
    }
    /* landscape -> horizontal image */
    @media (orientation: landscape) {
      body::before { background-image: url('sp-horizontal.png'); }
    }

    /* top fixed player (full-bleed width, 16:9) */
    .video-fixed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      /* default 16:9 by viewport width */
      height: calc(100vw * 9 / 16);
      background: #000;
      z-index: 1200; /* above background, below UI overlays */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 0;
    }
    /* on wide screens prefer a height relative to viewport */
    @media (min-width: 1000px) {
      .video-fixed { height: 56vh; }
    }
    .video-fixed iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    /* main content container (scrollable) sits beneath the fixed video */
    main.app {
      position: relative;
      z-index: 1250; /* above video and background */
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 20px;
      /* top padding must match current .video-fixed computed height (set by JS) */
      padding-top: calc(var(--player-height, 360px) + 20px);
      min-height: calc(100vh - 20px);
    }

    /* glass-black panels (square) */
    .panel {
      background: var(--panel-glass);
      border: 1px solid var(--panel-border);
      padding: 14px;
      margin-bottom: 14px;
      color: #fff;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }

    /* meta & controls */
    .meta { display:flex; flex-direction:column; gap:10px; }
    .title { font-family: "Space Grotesk", Inter, sans-serif; font-weight:800; font-size:20px; margin:0; color:#fff; line-height:1.15; }
    .sub { font-size:13px; color: var(--muted); }
    .meta-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { padding:6px 10px; font-weight:800; font-size:13px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); color:#fff; }

    /* description */
    .desc { color: #dbe2e6; font-size:14px; line-height:1.45; white-space:pre-wrap; word-break:break-word; max-height: none; }
    .desc-collapsed { max-height: 120px; overflow: hidden; }

    /* recommendations list */
    .recs { display:flex; flex-direction:column; gap:10px; }
    .rec { display:flex; gap:10px; align-items:flex-start; cursor:pointer; padding:8px; border:1px solid rgba(255,255,255,0.02); background: rgba(0,0,0,0.35); }
    .rec:hover { background: rgba(255,255,255,0.02); }
    .rec-thumb { width:150px; height:84px; background:#111; flex-shrink:0; display:block; }
    .rec-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .rec-title { font-weight:800; font-size:14px; color:#fff; }

    /* layout responsiveness */
    .grid {
      display:block;
      gap:12px;
    }
    @media (min-width: 1000px) {
      .grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
    }

    /* utility */
    .right-col { position: sticky; top: calc(var(--player-height, 360px) + 20px); } /* keeps recommendations visually below player */
    .muted { color: var(--muted); font-weight:700; }

    /* small screens tweaks */
    @media (max-width:420px) {
      .rec-thumb { width:120px; height:66px; }
    }

    /* ensure lucide SVGs inherit color */
    svg, svg * { color: inherit; stroke: currentColor; fill: none; }

    /* make links obvious on glass */
    a.glass-link { color: #8fd6ff; font-weight:700; text-decoration: none; }
    a.glass-link:hover { text-decoration: underline; }

    /* accessibility focus outlines */
    :focus { outline: 3px solid rgba(255,255,255,0.06); outline-offset:2px; }

  </style>
</head>
<body>
  <!-- FIXED 16:9 VIDEO (touches viewport edges, no corners) -->
  <div id="videoFixed" class="video-fixed" aria-label="Video player (fixed top)">
    <!-- iframe appended by JS -->
  </div>

  <!-- Main scrollable content beneath player -->
  <main class="app" id="app" role="main" aria-live="polite">
    <div class="grid">

      <!-- main column -->
      <section style="min-width:0;">
        <!-- meta panel (glass black) -->
        <div class="panel" id="metaPanel" role="region" aria-label="Video information">
          <h1 id="title" class="title">Loading…</h1>
          <div class="sub" id="channelLine">—</div>

          <div class="meta-row" style="margin-top:10px;">
            <div id="views" class="pill">— views</div>
            <div id="likes" class="pill">— likes</div>
            <a id="openInYouTube" class="glass-link" href="#" target="_blank" rel="noopener noreferrer" style="margin-left:auto;">Open on YouTube</a>
          </div>
        </div>

        <!-- description panel -->
        <div class="panel" id="descPanel" role="region" aria-label="Description">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800">Description</div>
            <div>
              <button id="toggleDesc" aria-expanded="false" style="background:transparent;border:1px solid var(--panel-border);padding:6px 8px;font-weight:800;cursor:pointer;color:#fff">Show more</button>
            </div>
          </div>

          <div id="descText" class="desc desc-collapsed" style="margin-top:10px;">Loading description…</div>
          <div id="descLinks" style="margin-top:10px"></div>
        </div>

        <!-- other panel (credits / tags / actions) -->
        <div class="panel" id="otherPanel" role="region" aria-label="Details">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <div style="font-weight:800">Tags & Credits</div>
            <div id="credits" class="muted">—</div>
          </div>

          <div style="margin-top:12px; display:flex;gap:8px; flex-wrap:wrap;">
            <button id="shareBtn" style="background:transparent;border:1px solid var(--panel-border);padding:8px 10px;font-weight:800;cursor:pointer;color:#fff">Share</button>
            <button id="favBtn" style="background:transparent;border:1px solid var(--panel-border);padding:8px 10px;font-weight:800;cursor:pointer;color:#fff">Save</button>
            <a id="supportEmail" class="glass-link" href="mailto:drboombaehelpline@gmail.com" style="padding:8px 10px;border:1px solid var(--panel-border);display:inline-block">Email Support</a>
            <a id="telegramLink" class="glass-link" href="https://t.me/Drboombae" target="_blank" rel="noopener noreferrer" style="padding:8px 10px;border:1px solid var(--panel-border);display:inline-block">Telegram</a>
          </div>
        </div>
      </section>

      <!-- right column: recommendations (sticky under player) -->
      <aside style="min-width:0;">
        <div class="right-col">
          <div class="panel" id="recsPanel" role="region" aria-label="Recommendations">
            <div style="font-weight:800;margin-bottom:8px">Recommended</div>
            <div id="recs" class="recs" aria-live="polite"></div>
            <div id="recsEmpty" class="muted" style="display:none;margin-top:8px">No recommendations available.</div>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <script>
    (function(){
      // ---------------------------
      // CONFIG: Firestore (compat)
      // ---------------------------
      // This app uses Firestore 'community_videos' collection only for recommendations (choice A).
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCPVer1Qg4ecHxbUKHUst8C0dyPCm8LEkM",
        authDomain: "community-7bd8d.firebaseapp.com",
        projectId: "community-7bd8d",
        storageBucket: "community-7bd8d.firebasestorage.app",
        messagingSenderId: "1034615155630",
        appId: "1:1034615155630:web:e4ee92c96c3a04875f363f",
        measurementId: "G-BW2QDBG8GC"
      };

      // ---------------------------
      // DOM refs
      // ---------------------------
      const params = new URLSearchParams(location.search);
      const rawVid = params.get('vid') || '';
      const videoFixed = document.getElementById('videoFixed');
      const titleEl = document.getElementById('title');
      const viewsEl = document.getElementById('views');
      const likesEl = document.getElementById('likes');
      const channelLine = document.getElementById('channelLine');
      const openInYouTube = document.getElementById('openInYouTube');
      const descText = document.getElementById('descText');
      const descLinks = document.getElementById('descLinks');
      const toggleDesc = document.getElementById('toggleDesc');
      const creditsEl = document.getElementById('credits');
      const recsContainer = document.getElementById('recs');
      const recsEmpty = document.getElementById('recsEmpty');
      const shareBtn = document.getElementById('shareBtn');
      const favBtn = document.getElementById('favBtn');

      // state
      let currentVideoId = '';
      let iframeEl = null;
      let db = null;
      let firestoreAvailable = false;

      // helpers
      function extractYouTubeID(input){
        if(!input) return '';
        const s = String(input).trim();
        const patterns = [
          /(?:youtu\.be\/)([A-Za-z0-9_\-]{11})/,
          /[?&]v=([A-Za-z0-9_\-]{11})/,
          /\/embed\/([A-Za-z0-9_\-]{11})/,
          /\/shorts\/([A-Za-z0-9_\-]{11})/,
          /([A-Za-z0-9_\-]{11})/
        ];
        for(const p of patterns){
          const m = s.match(p);
          if(m && m[1]) return m[1];
        }
        return '';
      }
      function niceNumber(n){
        if(n===undefined||n===null) return '—';
        const num = Number(n);
        if(Number.isNaN(num)) return String(n);
        if(num < 1000) return String(num);
        if(num < 1_000_000) return (num/1000).toFixed(num%1000 ? 1:0) + 'K';
        if(num < 1_000_000_000) return (num/1_000_000).toFixed(1) + 'M';
        return (num/1_000_000_000).toFixed(1) + 'B';
      }

      // create player iframe
      function createIframe(id){
        const ifr = document.createElement('iframe');
        ifr.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen');
        ifr.setAttribute('allowfullscreen','');
        ifr.src = `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&rel=0&modestbranding=1&playsinline=1`;
        return ifr;
      }

      // set CSS variable --player-height so main.app padding-top matches player height
      function syncPlayerHeightVar(){
        // compute height of .video-fixed (may change on resize)
        requestAnimationFrame(()=>{
          const h = videoFixed.getBoundingClientRect().height || Math.round(window.innerWidth * 9 / 16);
          document.documentElement.style.setProperty('--player-height', h + 'px');
          // also set main.app padding-top: handled by CSS using var(...)
        });
      }

      // initialize Firestore (compat)
      try {
        if(window.firebase && firebase && firebase.initializeApp){
          try { firebase.initializeApp(FIREBASE_CONFIG); } catch(e){}
          if(firebase.firestore){
            db = firebase.firestore();
            firestoreAvailable = true;
          }
        }
      } catch(e){
        console.warn('Firestore init failed', e);
        firestoreAvailable = false;
      }

      // fetch oEmbed for fallback title/desc if needed
      async function fetchOEmbed(videoId){
        try {
          const r = await fetch('https://www.youtube.com/oembed?url=' + encodeURIComponent('https://www.youtube.com/watch?v='+videoId) + '&format=json');
          if(!r.ok) return null;
          return await r.json();
        } catch(e){ return null; }
      }

      // Try to fetch video details via YouTube Data API when API key present (optional)
      const YT_API_KEY = ''; // leave empty unless you add one
      async function fetchVideoDetails(id){
        if(!id || !YT_API_KEY) return null;
        try {
          const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${encodeURIComponent(id)}&key=${YT_API_KEY}`;
          const r = await fetch(url);
          if(!r.ok) return null;
          const j = await r.json();
          if(Array.isArray(j.items) && j.items.length) return j.items[0];
          return null;
        } catch(e){ return null; }
      }

      // update UI with video info
      async function renderVideo(videoId){
        if(!videoId){
          titleEl.textContent = 'No video supplied';
          videoFixed.innerHTML = '<div style="padding:18px;color:#fff">Open this page with ?vid=&lt;YouTubeID or URL&gt;</div>';
          return;
        }
        currentVideoId = videoId;

        // placeholder
        titleEl.textContent = 'Loading…';
        viewsEl.textContent = '— views';
        likesEl.textContent = '— likes';
        channelLine.textContent = '—';
        descText.textContent = 'Loading description…';
        creditsEl.textContent = '—';
        openInYouTube.href = `https://youtube.com/watch?v=${encodeURIComponent(videoId)}`;

        // insert iframe
        iframeEl = createIframe(videoId);
        videoFixed.innerHTML = '';
        videoFixed.appendChild(iframeEl);
        syncPlayerHeightVar();

        // Try to load full details: priority YT Data API (if key set), else oEmbed
        let info = null;
        if(YT_API_KEY) info = await fetchVideoDetails(videoId).catch(()=>null);
        const oembed = (!info) ? await fetchOEmbed(videoId).catch(()=>null) : null;

        // populate from available sources
        const titleText = (info && info.snippet && info.snippet.title) || (oembed && oembed.title) || (`Video ${videoId}`);
        titleEl.textContent = titleText;

        const channel = (info && info.snippet && info.snippet.channelTitle) || (oembed && oembed.author_name) || '';
        channelLine.textContent = channel ? channel : '—';

        if(info && info.statistics){
          viewsEl.textContent = `${niceNumber(info.statistics.viewCount)} views`;
          likesEl.textContent = (info.statistics.likeCount !== undefined) ? `${niceNumber(info.statistics.likeCount)} likes` : '— likes';
        } else {
          viewsEl.textContent = '— views';
          likesEl.textContent = '— likes';
        }

        const desc = (info && info.snippet && info.snippet.description) || (oembed && oembed.html? '' : (oembed && oembed.title? '' : '')) || '';
        // If no description from YT, try oembed (oembed does not include full description usually)
        if(info && info.snippet && info.snippet.description) {
          descText.textContent = info.snippet.description;
        } else {
          // try oembed as fallback for minimal info
          descText.textContent = (oembed && oembed.title) ? `${oembed.title}` : '';
        }

        // show link chips for URLs inside description (basic)
        descLinks.innerHTML = '';
        const matches = (info && info.snippet && info.snippet.description) ? String(info.snippet.description).match(/https?:\/\/[^\s)]+/g) : [];
        (matches || []).slice(0,8).forEach(l => {
          const a = document.createElement('a');
          a.href = l; a.target = '_blank'; a.rel = 'noopener noreferrer';
          a.className = 'glass-link';
          a.style.display = 'inline-block';
          a.style.marginRight = '8px';
          a.textContent = l.replace(/^https?:\/\//,'').replace(/\/.*$/,'');
          descLinks.appendChild(a);
        });

        // credits placeholder (could derive from snippet.channelTitle)
        creditsEl.textContent = channel ? `Uploaded by ${channel}` : '—';
      }

      // load recommendations ONLY from Firestore 'community_videos', then randomize and display
      async function loadRecommendations(excludeVideoId){
        recsContainer.innerHTML = '';
        recsEmpty.style.display = 'none';

        if(!firestoreAvailable || !db){
          recsEmpty.textContent = 'Recommendations are not available.';
          recsEmpty.style.display = 'block';
          return;
        }

        try {
          // get all community_videos (limit to a reasonable max)
          const snapshot = await db.collection('community_videos').orderBy('createdAt','desc').limit(300).get();
          const pool = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            if(!d || !d.videoId) return;
            if(String(d.videoId) === String(excludeVideoId)) return;
            // ensure "real" videos only: require title and videoId
            if(!d.title || !d.videoId) return;
            pool.push({
              videoId: d.videoId,
              title: d.title,
              channelTitle: d.channelTitle || d.uploaderName || '',
              thumb: d.thumbnailUrl || `https://i.ytimg.com/vi/${d.videoId}/hqdefault.jpg`
            });
          });

          if(pool.length === 0){
            recsEmpty.textContent = 'No recommendations available.';
            recsEmpty.style.display = 'block';
            return;
          }

          // randomize pool (Fisher–Yates shuffle) and pick up to 8
          for(let i = pool.length - 1; i > 0; i--){
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
          }
          const chosen = pool.slice(0, 8);

          // render
          chosen.forEach(item => {
            const r = document.createElement('div');
            r.className = 'rec';
            r.tabIndex = 0;
            r.setAttribute('role','button');
            r.addEventListener('click', () => {
              // navigate to same page with new vid param
              const u = new URL(window.location.href);
              u.searchParams.set('vid', item.videoId);
              location.href = u.toString();
            });
            r.addEventListener('keydown', e => { if(e.key === 'Enter') r.click(); });

            const thumb = document.createElement('div');
            thumb.className = 'rec-thumb';
            const img = document.createElement('img');
            img.alt = item.title || 'thumbnail';
            img.src = item.thumb;
            thumb.appendChild(img);

            const meta = document.createElement('div');
            meta.style.flex = '1 1 auto';
            meta.style.minWidth = '0';
            const t = document.createElement('div');
            t.className = 'rec-title';
            t.textContent = item.title || 'Untitled';
            const ch = document.createElement('div');
            ch.className = 'muted';
            ch.style.marginTop = '6px';
            ch.textContent = item.channelTitle || '';
            meta.appendChild(t);
            meta.appendChild(ch);

            r.appendChild(thumb);
            r.appendChild(meta);
            recsContainer.appendChild(r);
          });

        } catch (e) {
          console.warn('Failed loading recommendations', e);
          recsEmpty.textContent = 'Unable to load recommendations.';
          recsEmpty.style.display = 'block';
        }
      }

      // share: try to include thumbnail file when supported
      async function shareCurrent(){
        const url = location.href;
        const title = titleEl.textContent || 'Video';
        // try fetch thumbnail from yt hqdefault
        const thumbUrl = `https://i.ytimg.com/vi/${encodeURIComponent(currentVideoId)}/hqdefault.jpg`;
        try {
          if(navigator.canShare){
            // attempt fetch blob
            let blob = null;
            try {
              const r = await fetch(thumbUrl, { mode: 'cors' });
              if(r.ok) blob = await r.blob();
            } catch(e){ blob = null; }
            if(blob){
              const file = new File([blob], 'thumbnail.jpg', { type: blob.type });
              if(navigator.canShare && navigator.canShare({ files: [file] })){
                await navigator.share({ title, text: title, url, files: [file] });
                return;
              }
            }
          }
          if(navigator.share){ await navigator.share({ title, text: title, url }); return; }
          await navigator.clipboard.writeText(url);
          alert('Link copied to clipboard');
        } catch(e){
          try { await navigator.clipboard.writeText(url); alert('Link copied to clipboard'); } catch(_){ alert('Unable to share'); }
        }
      }

      // favorites toggle (localStorage)
      function toggleFavorite(){
        const key = 'boombae_recs_favs_v1';
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ arr = []; }
        const exists = arr.find(x => x && x.videoId === currentVideoId);
        if(!exists){
          arr.unshift({ videoId: currentVideoId, title: titleEl.textContent || '' });
          localStorage.setItem(key, JSON.stringify(arr.slice(0, 80)));
          favBtn.textContent = 'Saved';
        } else {
          arr = arr.filter(x => x.videoId !== currentVideoId);
          localStorage.setItem(key, JSON.stringify(arr));
          favBtn.textContent = 'Save';
        }
      }

      // toggle description expand/collapse
      toggleDesc.addEventListener('click', () => {
        const expanded = toggleDesc.getAttribute('aria-expanded') === 'true';
        if(expanded){
          descText.classList.add('desc-collapsed');
          toggleDesc.setAttribute('aria-expanded','false');
          toggleDesc.textContent = 'Show more';
        } else {
          descText.classList.remove('desc-collapsed');
          toggleDesc.setAttribute('aria-expanded','true');
          toggleDesc.textContent = 'Show less';
        }
      });

      // share & fav buttons
      shareBtn.addEventListener('click', shareCurrent);
      favBtn.addEventListener('click', toggleFavorite);

      // On resize keep CSS var for player height in sync
      window.addEventListener('resize', syncPlayerHeightVar);

      // handle double click on video to toggle fullscreen (works for iframe container)
      videoFixed.addEventListener('dblclick', async () => {
        try {
          if(videoFixed.requestFullscreen) await videoFixed.requestFullscreen();
          else if(videoFixed.webkitRequestFullscreen) await videoFixed.webkitRequestFullscreen();
        } catch(e){}
      });

      // initialize lucide icons once loaded
      window.addEventListener('load', () => {
        try { if(window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons(); } catch(e){}
      });

      // boot: parse vid, render, and load recs
      (async function boot(){
        const vid = extractYouTubeID(rawVid || '');
        if(!vid){
          // nothing to show
          titleEl.textContent = 'No video specified';
          videoFixed.innerHTML = '<div style="padding:18px;color:#fff">Open this page with ?vid=&lt;YouTubeID or URL&gt;</div>';
          syncPlayerHeightVar();
          // still try to load recs (if any)
          await loadRecommendations(null);
          return;
        }
        await renderVideo(vid);
        // attempt to load recommendations from Firestore (choice A) — real only & random
        await loadRecommendations(vid);
        // ensure player height var is set
        syncPlayerHeightVar();
      })();

    })();
  </script>
</body>
</html>
