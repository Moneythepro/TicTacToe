<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Community — Video Player</title>

<!-- Fonts & Lucide -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>

<!-- No light theme: dark-only page -->
<style>
  :root{
    --bg-color: #000000;
    --panel: rgba(255,255,255,0.02);
    --muted: #9aa0a6;
    --text: #eef7ff;
    --accent: #3ec7ff;
    --gold: #f6d27a;
    --maxw: 1150px;
    --hdr-h: 64px;
    --gap: 12px;
  }

  /* Global: square corners - enforce */
  *{ box-sizing: border-box; border-radius: 0 !important; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  html,body{ height:100%; margin:0; background:var(--bg-color); color:var(--text); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; }

  /* fixed background images: portrait/landscape */
  body {
    background-image: url('sp-vertical.png');
    background-attachment: fixed;
    background-size: cover;
    background-position: center center;
  }
  @media (orientation: landscape) {
    body { background-image: url('sp-horizontal.png'); }
  }

  /* header */
  header.site-header {
    position: fixed; inset: 0 0 auto 0; height: var(--hdr-h); display:flex; align-items:center; gap:12px;
    padding:0 14px; background: linear-gradient(90deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45)); border-bottom:1px solid rgba(255,255,255,0.03); z-index:1200;
  }
  .header-inner { width:100%; max-width:var(--maxw); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .left-controls { display:flex; gap:8px; align-items:center; }
  .title { font-family:"Space Grotesk", Inter, sans-serif; font-weight:700; font-size:18px; color:var(--gold); line-height:1; margin:0; }
  .subtitle { font-size:12px; color:var(--muted); margin-top:2px; }

  /* icon-only buttons: no background */
  .icon-btn { width:40px; height:40px; display:inline-grid; place-items:center; border:0; background:transparent; color:var(--text); cursor:pointer; }
  .icon-btn:active{ transform:translateY(1px); }

  /* main page layout */
  main.page { width:100%; max-width:var(--maxw); margin: calc(var(--hdr-h) + 18px) auto 48px; padding:12px; }
  .container { display:block; gap:var(--gap); }
  @media(min-width:1000px){ .container { display:grid; grid-template-columns: 1fr 360px; gap:22px; } }

  /* full-width sticky player -- option 2 */
  .player-wrap {
    position: sticky;
    top: calc(var(--hdr-h) + 12px);
    z-index:1100;
    background:#000;
    border:1px solid rgba(255,255,255,0.03);
    overflow:hidden;
  }
  .player-inner { width:100%; height:0; padding-bottom:56.25%; position:relative; } /* 16:9 */
  .player-iframe { position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; display:block; }

  /* meta / controls below player */
  .meta-card { background: var(--panel); border:1px solid rgba(255,255,255,0.03); padding:12px; margin-top:12px; }
  .video-title { margin:0; font-size:20px; font-weight:800; color:var(--text); line-height:1.1; }
  .stats-row { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .pill { font-weight:800; padding:6px 10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); }

  .channel-row { display:flex; gap:12px; align-items:center; margin-top:12px; }
  .avatar { width:56px; height:56px; background:#111; flex-shrink:0; overflow:hidden; }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* description */
  .desc { margin-top:12px; color:var(--text); font-size:14px; line-height:1.5; white-space:pre-line; }
  .desc-collapsed { max-height:64px; overflow:hidden; }
  .desc-toggle { display:inline-block; margin-top:8px; color:var(--accent); cursor:pointer; font-weight:800; }

  /* recommendations on right column */
  .aside { }
  .recs-card { background:var(--panel); border:1px solid rgba(255,255,255,0.03); padding:12px; }
  .rec-item { display:flex; gap:10px; align-items:flex-start; padding:8px 6px; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,0.02); }
  .rec-item:last-child{ border-bottom:0; }
  .rec-thumb { width:120px; height:68px; background:#111; flex-shrink:0; overflow:hidden; }
  .rec-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .rec-meta { display:flex; flex-direction:column; min-width:0; }
  .rec-title { font-weight:800; font-size:13px; color:var(--text); line-height:1.15; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }

  /* mobile recommendations under content */
  .recs-mobile { margin-top:14px; background:var(--panel); border:1px solid rgba(255,255,255,0.03); padding:10px; }

  /* footer spacing */
  footer.site-foot { margin-top:18px; text-align:center; color:var(--muted); font-size:13px; }

  /* ensure icons inherit color and have no background */
  svg, svg * { stroke: currentColor; fill: none; color: inherit; }

  /* accessibility focus */
  :focus { outline: 2px solid rgba(62,199,255,0.12); outline-offset:2px; }

  /* small screens tweaks */
  @media(max-width:640px){
    .container { display:block; }
    .rec-thumb { width:100px; height:56px; }
    .avatar { width:48px; height:48px; }
    .player-wrap{ top: calc(var(--hdr-h) + 8px); }
  }

  /* remove scroll from background (background-attachment fixed handles it). nothing extra needed */
</style>
</head>
<body>

<!-- Header -->
<header class="site-header" role="banner" aria-label="Top bar">
  <div class="header-inner">
    <div class="left-controls" style="align-items:center;">
      <button id="backBtn" class="icon-btn" aria-label="Back" title="Back">
        <svg data-lucide="arrow-left" width="18" height="18"></svg>
      </button>
      <div style="margin-left:8px;">
        <div class="title">Boombae Game Store</div>
        <div class="subtitle" id="headerSubtitle">Community Videos</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <button id="shareBtn" class="icon-btn" aria-label="Share" title="Share">
        <svg data-lucide="share-2" width="18" height="18"></svg>
      </button>
      <button id="themeBtn" class="icon-btn" aria-label="Toggle theme" title="Toggle theme" style="display:none" aria-hidden="true">
        <svg data-lucide="sun" width="18" height="18"></svg>
      </button>
    </div>
  </div>
</header>

<!-- Page -->
<main class="page" role="main" aria-live="polite">
  <div class="container">

    <!-- Left column: player + meta + description -->
    <div>
      <!-- Player (full width, sticky) -->
      <div class="player-wrap" aria-hidden="false" id="playerWrap">
        <div class="player-inner" id="playerInner" aria-label="Video player area">
          <!-- iframe appended by JS -->
        </div>
      </div>

      <!-- Meta card -->
      <div class="meta-card" role="region" aria-label="Video details">
        <h1 id="videoTitle" class="video-title">Loading…</h1>

        <div class="stats-row" aria-hidden="false">
          <div id="views" class="pill">— views</div>
          <div id="likes" class="pill">— likes</div>
        </div>

        <div class="channel-row">
          <div class="avatar" id="avatarWrap"><img id="avatarImg" src="" alt="Channel avatar" /></div>
          <div>
            <div id="channelName" style="font-weight:800;color:var(--text);">—</div>
            <div id="channelSubs" style="color:var(--muted);font-weight:700;font-size:13px;">—</div>
          </div>
        </div>

        <div class="desc" id="descBlock">
          <div id="descText" class="desc-collapsed">Loading description…</div>
          <div>
            <button id="descToggleBtn" class="desc-toggle" aria-expanded="false">Show more</button>
          </div>
        </div>
      </div>

      <!-- mobile recs fallback -->
      <div id="recsMobile" class="recs-mobile" aria-label="Recommended videos (mobile)">
        <div style="font-weight:800;margin-bottom:8px">Recommended</div>
        <div id="recsMobileList"></div>
      </div>
    </div>

    <!-- Right column: recommendations -->
    <aside class="aside" aria-label="Recommendations">
      <div class="recs-card" id="recsRightCard" aria-hidden="false">
        <div style="font-weight:800;margin-bottom:8px">Recommended</div>
        <div id="recsRightList" aria-live="polite"></div>
      </div>
    </aside>
  </div>

  <footer class="site-foot">© <span id="year"></span> Boombae</footer>
</main>

<!-- Toast -->
<div id="toast" aria-hidden="true" style="position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:rgba(255,255,255,0.06);padding:8px 12px;color:var(--text);font-weight:800;z-index:1400;"></div>

<!-- Script: logic (YouTube details + shuffle recs + share with thumbnail) -->
<script type="module">
  // CONFIG
  const API_KEY = ''; // optional YouTube API key (leave empty to use oEmbed + fallback)
  const rawVid = new URLSearchParams(location.search).get('vid') || ''; // ?vid=
  const DEFAULT_THUMB = (id) => `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;

  // DOM refs
  const playerInner = document.getElementById('playerInner');
  const videoTitle = document.getElementById('videoTitle');
  const viewsEl = document.getElementById('views');
  const likesEl = document.getElementById('likes');
  const channelNameEl = document.getElementById('channelName');
  const channelSubsEl = document.getElementById('channelSubs');
  const avatarImg = document.getElementById('avatarImg');
  const descTextEl = document.getElementById('descText');
  const descToggleBtn = document.getElementById('descToggleBtn');
  const recsRightList = document.getElementById('recsRightList');
  const recsMobileList = document.getElementById('recsMobileList');
  const recsRightCard = document.getElementById('recsRightCard');
  const playerWrap = document.getElementById('playerWrap');
  const toastEl = document.getElementById('toast');
  const shareBtn = document.getElementById('shareBtn');
  const backBtn = document.getElementById('backBtn');

  document.getElementById('year').textContent = (new Date()).getFullYear();

  // util helpers
  const esc = s => String(s || '');
  const nice = n => {
    if (n === undefined || n === null) return '—';
    const num = Number(n);
    if (Number.isNaN(num)) return String(n);
    if (num < 1000) return String(num);
    if (num < 1_000_000) return (num/1000).toFixed(num%1000?1:0) + 'K';
    if (num < 1_000_000_000) return (num/1_000_000).toFixed(1) + 'M';
    return (num/1_000_000_000).toFixed(1) + 'B';
  };

  function showToast(msg, ms=1800){
    toastEl.textContent = msg;
    toastEl.style.opacity = '1';
    toastEl.style.pointerEvents = 'auto';
    setTimeout(()=> { toastEl.style.opacity = '0'; toastEl.style.pointerEvents = 'none'; }, ms);
  }

  function extractYouTubeID(input=''){
    if(!input) return '';
    const s = String(input).trim();
    const patterns = [/youtu\.be\/([A-Za-z0-9_-]{11})/, /[?&]v=([A-Za-z0-9_-]{11})/, /\/embed\/([A-Za-z0-9_-]{11})/, /\/shorts\/([A-Za-z0-9_-]{11})/, /([A-Za-z0-9_-]{11})/];
    for(const p of patterns){ const m = s.match(p); if(m && m[1]) return m[1]; }
    return '';
  }

  function createIframe(id){
    const f = document.createElement('iframe');
    f.className = 'player-iframe';
    f.loading = 'lazy';
    f.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen';
    f.allowFullscreen = true;
    f.src = `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&rel=0&modestbranding=1&playsinline=1`;
    return f;
  }

  async function fetchOEmbed(id){
    try{
      const r = await fetch('https://www.youtube.com/oembed?url=' + encodeURIComponent('https://www.youtube.com/watch?v='+id) + '&format=json');
      if(!r.ok) return null;
      return await r.json();
    }catch(e){ return null; }
  }

  async function fetchVideoDetails(id){
    if(!API_KEY || !id) return null;
    try{
      const part='snippet,statistics';
      const r = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=${part}&id=${encodeURIComponent(id)}&key=${API_KEY}`);
      if(!r.ok) return null;
      const j = await r.json();
      if(Array.isArray(j.items) && j.items.length) return j.items[0];
      return null;
    }catch(e){ return null; }
  }

  async function fetchRelated(id, max=12){
    if(!API_KEY || !id) return [];
    try{
      const r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId=${encodeURIComponent(id)}&type=video&maxResults=${max}&key=${API_KEY}`);
      if(!r.ok) return [];
      const j = await r.json();
      if(!Array.isArray(j.items)) return [];
      return j.items.map(it => ({
        videoId: it.id?.videoId,
        title: it.snippet?.title,
        channelTitle: it.snippet?.channelTitle,
        thumb: it.snippet?.thumbnails?.medium?.url || it.snippet?.thumbnails?.default?.url || ''
      })).filter(Boolean);
    }catch(e){ return []; }
  }

  function shuffle(a){
    const arr = Array.isArray(a)? a.slice() : [];
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }

  function buildRecElement(item){
    const wrap = document.createElement('div'); wrap.className='rec-item';
    const th = document.createElement('div'); th.className='rec-thumb';
    const img = document.createElement('img'); img.src = item.thumb || DEFAULT_THUMB(item.videoId); img.alt = item.title || 'thumb';
    th.appendChild(img);
    const meta = document.createElement('div'); meta.className='rec-meta';
    const t = document.createElement('div'); t.className='rec-title'; t.textContent = item.title || 'Untitled';
    const ch = document.createElement('div'); ch.style.color='var(--muted)'; ch.style.fontWeight='700'; ch.style.fontSize='12px'; ch.textContent = item.channelTitle || '';
    meta.appendChild(t); meta.appendChild(ch);
    wrap.appendChild(th); wrap.appendChild(meta);
    wrap.tabIndex = 0;
    wrap.addEventListener('click', ()=> { location.search = '?vid=' + encodeURIComponent(item.videoId); });
    wrap.addEventListener('keydown', (e)=> { if(e.key === 'Enter') wrap.click(); });
    return wrap;
  }

  // share including thumbnail when possible
  async function shareCurrent({title, text, url, thumbSrc}){
    const shareText = `${text ? text + '\n' : ''}${url}`;
    try{
      // try fetch thumbnail and use Web Share with files if supported
      if(thumbSrc && navigator.canShare){
        let blob = null;
        try {
          const r = await fetch(thumbSrc, {mode:'cors'});
          if(r.ok) blob = await r.blob();
        } catch(e){ blob = null; }
        if(blob){
          const ext = (blob.type.split('/')[1] || 'png').split(';')[0];
          const file = new File([blob], 'thumbnail.'+ext, { type: blob.type });
          if(navigator.canShare && navigator.canShare({ files:[file] })){
            await navigator.share({ title, text: shareText, files: [file], url });
            return;
          }
        }
      }
      // fallback to navigator.share
      if(navigator.share){
        await navigator.share({ title, text: shareText, url });
        return;
      }
      // fallback copy
      if(navigator.clipboard){
        await navigator.clipboard.writeText(url);
        showToast('Link copied to clipboard');
        return;
      }
    }catch(e){
      try { await navigator.clipboard.writeText(url); showToast('Link copied to clipboard'); } catch(_) { showToast('Unable to share'); }
    }
  }

  // show/hide recs right column based on width
  function adaptRecsLayout(){
    const right = document.querySelector('.aside');
    if(window.innerWidth >= 1000){
      right.style.display = '';
      recsMobileList.parentElement.style.display = 'none';
    } else {
      right.style.display = 'none';
      recsMobileList.parentElement.style.display = '';
    }
  }

  // render recommendations: shuffle for randomness
  function renderRecommendations(list){
    const shuffled = shuffle(list || []);
    recsRightList.innerHTML = '';
    recsMobileList.innerHTML = '';
    shuffled.forEach(item => {
      recsRightList.appendChild(buildRecElement(item));
      recsMobileList.appendChild(buildRecElement(item).cloneNode(true));
    });
  }

  // main render flow for option 2 (full-width player at top, sticky)
  (async function init(){
    // init lucide icons once loaded
    window.addEventListener('load', ()=> { try{ if(window.lucide) window.lucide.createIcons(); }catch(e){} });

    // wire back & share
    backBtn.addEventListener('click', ()=> history.back());
    shareBtn.addEventListener('click', async ()=>{
      await shareCurrent({
        title: videoTitle.textContent || 'Boombae Video',
        text: (descTextEl.textContent || '').slice(0,140),
        url: location.href,
        thumbSrc: (playerInner.dataset.thumb || '')
      });
    });

    // desc toggle
    descToggleBtn.addEventListener('click', ()=>{
      const collapsed = descTextEl.classList.toggle('desc-collapsed');
      descToggleBtn.textContent = collapsed ? 'Show more' : 'Show less';
      descToggleBtn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
    });

    // adapt recs initially and on resize
    adaptRecsLayout();
    window.addEventListener('resize', adaptRecsLayout);

    const vid = extractYouTubeID(rawVid || '');
    if(!vid){
      videoTitle.textContent = 'No video supplied';
      playerInner.innerHTML = '<div style="padding:18px;color:var(--text)">Use ?vid=&lt;YouTubeID or URL&gt;</div>';
      recsRightCard.style.display = 'none';
      return;
    }

    // put iframe
    const iframe = createIframe(vid);
    playerInner.innerHTML = ''; playerInner.appendChild(iframe);

    // set dataset thumb for sharing fallback
    playerInner.dataset.thumb = DEFAULT_THUMB(vid);

    // load oEmbed and optionally video details via API
    let info = null;
    if(API_KEY) info = await fetchVideoDetails(vid).catch(()=>null);
    const oembed = (!info) ? await fetchOEmbed(vid).catch(()=>null) : null;

    // populate UI
    const title = (info?.snippet?.title) || (oembed?.title) || `Video ${vid}`;
    videoTitle.textContent = title;

    const channelTitle = info?.snippet?.channelTitle || oembed?.author_name || '';
    channelNameEl.textContent = channelTitle;

    if(info?.snippet?.thumbnails){
      const thumb = info.snippet.thumbnails?.medium?.url || info.snippet.thumbnails?.default?.url || DEFAULT_THUMB(vid);
      playerInner.dataset.thumb = thumb;
    } else if(oembed?.thumbnail_url){
      playerInner.dataset.thumb = oembed.thumbnail_url;
    } else {
      playerInner.dataset.thumb = DEFAULT_THUMB(vid);
    }

    // avatar & subs (if API available)
    if(info?.snippet?.channelId && API_KEY){
      try{
        const ch = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${encodeURIComponent(info.snippet.channelId)}&key=${API_KEY}`).then(r=>r.ok? r.json() : null);
        if(ch && Array.isArray(ch.items) && ch.items[0]){
          const c = ch.items[0];
          avatarImg.src = c.snippet?.thumbnails?.default?.url || '';
          channelNameEl.textContent = c.snippet?.title || channelTitle;
          channelSubsEl.textContent = c.statistics?.subscriberCount ? nice(c.statistics.subscriberCount) + ' subscribers' : '';
        }
      }catch(e){}
    } else {
      avatarImg.src = '';
      channelSubsEl.textContent = '';
    }

    // stats (views/likes) from API if available
    if(info?.statistics){
      viewsEl.textContent = nice(info.statistics.viewCount) + ' views';
      likesEl.textContent = (info.statistics.likeCount !== undefined) ? nice(info.statistics.likeCount) + ' likes' : '— likes';
    } else {
      viewsEl.textContent = '— views';
      likesEl.textContent = '— likes';
    }

    // description
    const descTextRaw = info?.snippet?.description || oembed?.author_name ? (oembed?.author_name + '') : (oembed?.title?oembed.title:'') || '';
    const finalDesc = (info?.snippet?.description) || (oembed?.title ? ('By ' + oembed.title) : '') || '';
    descTextEl.textContent = finalDesc || '—';
    // show more button only when description long
    if((descTextEl.textContent||'').length < 160) { descToggleBtn.style.display = 'none'; descTextEl.classList.remove('desc-collapsed'); }
    else { descToggleBtn.style.display = ''; descTextEl.classList.add('desc-collapsed'); descToggleBtn.textContent = 'Show more'; }

    // Recommendations: attempt to use YouTube related (if API_KEY) else fallback to a small list using oembed
    let pool = [];
    if(API_KEY){
      try{ pool = await fetchRelated(vid, 24); }catch(e){ pool = []; }
    }
    // If pool empty, try a simple fallback set (use oembed on a few ids to produce variety). We'll produce a small set of ids to try.
    if(!pool.length){
      const fallbackIds = ['dQw4w9WgXcQ','3JZ_D3ELwOQ','M3Z0Z4lJwHk','LXb3EKWsInQ','kXYiU_JCYtU']; // sample public ids
      pool = await Promise.all(fallbackIds.map(async id => {
        const oe = await fetchOEmbed(id).catch(()=>null);
        return { videoId: id, title: oe?.title || ('Video ' + id), channelTitle: oe?.author_name || '' , thumb: oe?.thumbnail_url || DEFAULT_THUMB(id) };
      })).catch(()=>[]);
    }

    // Shuffle pool and take up to 12
    pool = shuffle(pool).slice(0,12);

    // ensure required fields
    pool = pool.map(it => ({ videoId: it.videoId, title: it.title || ('Video ' + it.videoId), channelTitle: it.channelTitle || '', thumb: it.thumb || DEFAULT_THUMB(it.videoId) }));

    // render recs
    renderRecommendations(pool);

    // if no recs -> hide aside
    if(!(pool && pool.length)){
      recsRightCard.style.display = 'none';
    }

    // create lucide icons (static ones)
    try{ if(window.lucide) window.lucide.createIcons(); }catch(e){}

  })();

  // create icons when lucide loads if not yet created
  window.addEventListener('load', ()=> { try{ if(window.lucide) window.lucide.createIcons(); }catch(e){} });

</script>

</body>
</html>
