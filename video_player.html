<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Community — Video Player</title>

  <!-- Fonts & Lucide icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>

  <!-- Firebase (compat drop-in) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg-dark: #070708;
      --panel-dark: rgba(255,255,255,0.02);
      --muted-dark: #9aa0a6;
      --accent: #ff3b30;
      --glass: rgba(255,255,255,0.02);
      --radius: 12px;
      --maxw: 1100px;
      --gap: 12px;
      --player-h-mobile: calc(100vw * 9 / 16);
      --player-h-desktop: 56vh;
      --header-h: 0px; /* header removed */
    }

    /* Base (dark forced) */
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg-dark);
      color:#fff;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    *{ box-sizing:border-box; }
    a{ color:var(--accent); text-decoration:none; }
    img{ display:block; max-width:100%; height:auto; }

    /* Page container: keep a small gutter so player doesn't touch screen corners */
    .page {
      max-width:var(--maxw);
      margin:0 auto;
      padding:12px;
      padding-top:12px;
    }

    /* Layout: two columns on wide screens */
    .layout { display:grid; grid-template-columns: 1fr; gap:12px; padding-bottom:40px; }
    @media(min-width:1000px){ .layout { grid-template-columns: 1fr 360px; } }

    /* Card wrapper (semi-opaque dark surface) */
    .card {
      background:var(--panel-dark);
      border-radius:12px;
      border:1px solid var(--glass);
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      overflow:visible;
    }

    /* Sticky player area:
       - position: sticky so it remains visible while scrolling
       - high z-index so other content scrolls *under* it
       - maintain 16:9 with defined heights for mobile & desktop
       - rounded corners and small gutter so it doesn't touch corners
    */
    .player-sticky {
      position:sticky;
      top:12px;
      z-index:60;
      border-radius:10px;
      overflow:hidden;
      background:#000;
      margin: -6px; /* slightly offset so player sits visually separate from card border */
      padding: 6px; /* inner gutter keeps the actual iframe from touching corners */
    }
    .player {
      width:100%;
      height:var(--player-h-mobile);
      min-height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      border-radius:8px;
      overflow:hidden;
    }
    @media(min-width:1000px){
      .player { height:var(--player-h-desktop); min-height:260px; }
    }
    .player iframe { width:100%; height:100%; border:0; display:block; background:#000; }

    /* Controls (kept minimal) */
    .controls { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,0.01); background: linear-gradient(180deg, rgba(255,255,255,0.005), transparent); }
    .controls .left { display:flex; gap:12px; align-items:center; min-width:0; }
    .views { color:var(--muted-dark); font-weight:700; font-size:13px; white-space:nowrap; }
    .pill { font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); color:#fff; }

    /* Meta area */
    .meta { padding:12px; display:flex; flex-direction:column; gap:8px; background:transparent; }
    .title { font-family:"Space Grotesk", Inter, sans-serif; font-weight:800; font-style:italic; margin:0; color:#fff; line-height:1.15; font-size:18px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; word-break:break-word; }
    .sub-row { display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; }
    .channel { display:flex; gap:12px; align-items:center; min-width:0; }
    .avatar { width:48px; height:48px; border-radius:50%; overflow:hidden; flex-shrink:0; background:#111; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .channel-meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .channel-name { font-weight:800; font-size:14px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .subs { font-size:12px; color:var(--muted-dark); font-weight:700; }

    .subscribe { margin-left:auto; display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:var(--accent); color:#fff; border:0; font-weight:900; cursor:pointer; text-transform:uppercase; letter-spacing:0.04em; font-size:13px; }

    /* Description */
    .desc-toggle { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-radius:10px; cursor:pointer; background:linear-gradient(180deg, rgba(255,255,255,0.005), transparent); border:1px solid rgba(255,255,255,0.01); }
    .desc-title { font-weight:800; color:#fff; font-size:14px; }
    .desc-body { max-height:0; overflow:hidden; transition: max-height .28s ease, padding .28s ease; padding:0 10px; }
    .desc-body.open { padding:10px; max-height:420px; }
    .desc-text { color:#dbe2e6; font-size:14px; line-height:1.45; white-space:pre-wrap; word-break:break-word; }
    .link-chip { display:inline-block; font-size:12px; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); color:var(--accent); border:1px solid rgba(255,255,255,0.02); margin-right:6px; margin-top:6px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Recommendations */
    .recs { display:flex; flex-direction:column; gap:10px; padding:6px; }
    .rec-item { display:flex; gap:10px; align-items:flex-start; padding:8px; border-radius:10px; cursor:pointer; transition: transform .12s ease, background .12s ease; min-height:64px; }
    .rec-item:hover, .rec-item:focus { transform:translateX(6px); background: rgba(255,255,255,0.02); outline:none; }
    .rec-thumb { width:140px; height:78px; flex-shrink:0; border-radius:8px; overflow:hidden; background:#111; }
    .rec-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .rec-meta { display:flex; flex-direction:column; gap:6px; min-width:0; }
    .rec-title { font-weight:800; font-size:14px; color:#fff; line-height:1.15; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; word-break:break-word; }
    .rec-ch { font-size:12px; color:var(--muted-dark); font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    @media(max-width:420px){
      .rec-thumb { width:120px; height:66px; }
      .player { height:calc(100vw * 9/16); }
      .title { font-size:16px; -webkit-line-clamp:2; }
      .avatar { width:40px; height:40px; }
    }

    /* keep the description's visual debug class removed */
    .desc-body.open { background:transparent; }

    /* accessibility helper */
    .sr-only { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; top:auto; }

    /* ensure the right column is visually distinct on wide screens */
    aside .panel-inner { background:var(--panel-dark); padding:12px; border-radius:12px; border:1px solid var(--glass); box-shadow:0 20px 40px rgba(0,0,0,0.5); }
  .page{
  padding:0;                 /* No gutter */
  max-width:none;            /* Full width layout */
}

.player-sticky{
  margin:0;                  /* No offset */
  border-radius:0;           /* Touch corners */
  padding:0;
  top:0;                     /* Stick from absolute top */
}

.player{
  border-radius:0;
  width:100vw;               /* FULL WIDTH */
  margin-left:50%;
  transform:translateX(-50%); /* Prevent body margin shifts */
}
    .card{
  border-radius:0;           /* Flat layer under video */
  margin-top:-5px;           /* Seamless connect */
  background:var(--panel-dark);
  padding-top:0;
    }
  </style>
</head>

<body>
  <div class="page" role="application" aria-label="Community video player">

    <main class="layout" role="main" aria-live="polite">
      <!-- Main column: player + meta + recs -->
      <section>
        <div class="card" aria-hidden="false">
          <div class="player-sticky" id="playerSticky" aria-hidden="false">
            <div id="player" class="player" aria-label="Video player region">
              <!-- iframe created by JS -->
            </div>
          </div>

          <!-- controls: only views & likes pills left -->
          <div class="controls" role="region" aria-label="Video stats">
            <div class="left">
              <div id="views" class="views">— views</div>
              <div id="likesPill" class="pill" aria-hidden="true">— likes</div>
            </div>
            <div style="width:1px"></div>
          </div>

          <div class="meta" id="meta">
            <h1 id="title" class="title">Loading…</h1>

            <div class="sub-row">
              <div class="channel" role="group" aria-label="Channel info">
                <div class="avatar" id="avatar"><img alt="avatar" src="" /></div>
                <div class="channel-meta">
                  <div id="channelName" class="channel-name">—</div>
                  <div id="channelSubs" class="subs">—</div>
                </div>
              </div>

              <button id="subscribeBtn" class="subscribe" aria-label="Subscribe">Subscribe</button>
            </div>

            <!-- description -->
            <div style="margin-top:8px">
              <div id="descToggle" class="desc-toggle" role="button" tabindex="0" aria-expanded="false">
                <div class="desc-title">Description</div>
                <div id="descState" class="muted">Show more</div>
              </div>
              <div id="descBody" class="desc-body" aria-hidden="true">
                <div id="descText" class="desc-text">Loading description…</div>
                <div id="descLinks" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile recommendations -->
        <div id="recsMobile" style="margin-top:12px;">
          <div style="font-weight:800; font-size:14px; margin:8px 6px 6px 6px">Recommended</div>
          <div class="recs" id="recsList"></div>
        </div>
      </section>

      <!-- Right column for wider screens -->
      <aside id="recsRight" style="display:none;">
        <div style="position:sticky; top:68px; padding:12px;">
          <div class="panel-inner">
            <div style="font-weight:800; font-size:14px; margin-bottom:8px">Recommended</div>
            <div class="recs" id="recsListRight"></div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const API_KEY = 'AIzaSyA97DNGHIF85wLeIlDndNtOWTA6BofbJ0A'; // optional YouTube Data API key
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCPVer1Qg4ecHxbUKHUst8C0dyPCm8LEkM",
      authDomain: "community-7bd8d.firebaseapp.com",
      projectId: "community-7bd8d",
      storageBucket: "community-7bd8d.firebasestorage.app",
      messagingSenderId: "1034615155630",
      appId: "1:1034615155630:web:e4ee92c96c3a04875f363f",
      measurementId: "G-BW2QDBG8GC"
    };

    // ---------- DOM ----------
    const params = new URLSearchParams(window.location.search);
    const rawVid = params.get('vid') || '';
    const playerEl = document.getElementById('player');
    const playerSticky = document.getElementById('playerSticky');

    const titleEl = document.getElementById('title');
    const viewsEl = document.getElementById('views');
    const likesPill = document.getElementById('likesPill');

    const avatarEl = document.getElementById('avatar').querySelector('img');
    const channelNameEl = document.getElementById('channelName');
    const channelSubsEl = document.getElementById('channelSubs');
    const subscribeBtn = document.getElementById('subscribeBtn');

    const descToggle = document.getElementById('descToggle');
    const descBody = document.getElementById('descBody');
    const descText = document.getElementById('descText');
    const descLinks = document.getElementById('descLinks');
    const descState = document.getElementById('descState');

    const backBtn = null; // header removed
    const shareBtn = null;

    const recsList = document.getElementById('recsList');
    const recsListRight = document.getElementById('recsListRight');
    const recsRight = document.getElementById('recsRight');
    const recsMobile = document.getElementById('recsMobile');

    // ---------- STATE ----------
    let currentVideoId = '';
    let iframe = null;
    let recommendations = [];
    let firestoreAvailable = false;
    let db = null;

    // ---------- FIREBASE INIT ----------
    try {
      if (typeof firebase !== 'undefined' && firebase && firebase.initializeApp) {
        try { firebase.initializeApp(FIREBASE_CONFIG); } catch(e){}
        if (firebase.firestore) {
          db = firebase.firestore();
          firestoreAvailable = true;
        }
      }
    } catch(e){
      firestoreAvailable = false;
    }

    // ---------- HELPERS ----------
    function extractYouTubeID(input){
      if (!input) return '';
      const s = String(input).trim();
      const patterns = [
        /(?:youtu\.be\/)([A-Za-z0-9_\-]{11})/,
        /[?&]v=([A-Za-z0-9_\-]{11})/,
        /\/embed\/([A-Za-z0-9_\-]{11})/,
        /\/shorts\/([A-Za-z0-9_\-]{11})/,
        /([A-Za-z0-9_\-]{11})/
      ];
      for (const p of patterns){
        const m = s.match(p);
        if (m && m[1]) return m[1];
      }
      return '';
    }

    function niceNumber(n){
      if (n === undefined || n === null) return '—';
      const num = Number(n);
      if (Number.isNaN(num)) return String(n);
      if (num < 1000) return String(num);
      if (num < 1_000_000) return (num/1000).toFixed(num%1000 ? 1:0) + 'K';
      if (num < 1_000_000_000) return (num/1_000_000).toFixed(1) + 'M';
      return (num/1_000_000_000).toFixed(1) + 'B';
    }

    function setText(el, text){ if (!el) return; el.textContent = text === undefined || text === null ? '' : String(text); }

    async function fetchOEmbed(id){
      if (!id) return null;
      try {
        const r = await fetch('https://www.youtube.com/oembed?url=' + encodeURIComponent('https://www.youtube.com/watch?v='+id) + '&format=json');
        if (!r.ok) return null;
        return await r.json();
      } catch(e){ return null; }
    }

    async function fetchVideoDetails(id){
      if (!API_KEY || !id) return null;
      try {
        const parts = ['snippet','contentDetails','statistics'].join(',');
        const url = `https://www.googleapis.com/youtube/v3/videos?part=${parts}&id=${encodeURIComponent(id)}&key=${API_KEY}`;
        const r = await fetch(url);
        if (!r.ok) return null;
        const j = await r.json();
        if (Array.isArray(j.items) && j.items.length) return j.items[0];
        return null;
      } catch(e){ return null; }
    }

    async function fetchChannel(channelId){
      if (!API_KEY || !channelId) return null;
      try {
        const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${encodeURIComponent(channelId)}&key=${API_KEY}`;
        const r = await fetch(url);
        if (!r.ok) return null;
        const j = await r.json();
        if (Array.isArray(j.items) && j.items.length) return j.items[0];
        return null;
      } catch(e){ return null; }
    }

    async function fetchRelated(id, limit=12){
      if (!API_KEY || !id) return [];
      try {
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId=${encodeURIComponent(id)}&type=video&maxResults=${limit}&key=${API_KEY}`;
        const r = await fetch(url);
        if (!r.ok) return [];
        const j = await r.json();
        if (!Array.isArray(j.items)) return [];
        return j.items.map(it => ({
          videoId: it.id.videoId,
          title: it.snippet.title,
          channelTitle: it.snippet.channelTitle,
          thumb: it.snippet.thumbnails?.medium?.url || it.snippet.thumbnails?.default?.url || ''
        })).filter(Boolean);
      } catch(e){ return []; }
    }

    function createIframe(videoId){
      const frame = document.createElement('iframe');
      frame.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen');
      frame.setAttribute('allowfullscreen', '');
      frame.className = 'player-iframe';
      frame.title = 'YouTube player';
      frame.loading = 'lazy';
      frame.src = `https://www.youtube.com/embed/${encodeURIComponent(videoId)}?autoplay=0&rel=0&modestbranding=1&playsinline=1`;
      return frame;
    }

    function buildRecRow(item){
      const row = document.createElement('div'); row.className = 'rec-item'; row.tabIndex = 0;
      row.setAttribute('role','button');
      row.addEventListener('click', () => {
        const u = new URL(window.location.href);
        u.searchParams.set('vid', item.videoId);
        window.location.href = u.toString();
      });
      row.addEventListener('keydown', (e) => { if (e.key === 'Enter') row.click(); });

      const th = document.createElement('div'); th.className = 'rec-thumb';
      const img = document.createElement('img'); img.alt = item.title || 'thumbnail';
      img.src = item.thumb || `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      th.appendChild(img);

      const meta = document.createElement('div'); meta.className = 'rec-meta';
      const t = document.createElement('div'); t.className = 'rec-title'; t.textContent = item.title || 'Untitled';
      const ch = document.createElement('div'); ch.className = 'rec-ch'; ch.textContent = item.channelTitle || (item.brand || '');
      meta.appendChild(t); meta.appendChild(ch);

      row.appendChild(th); row.appendChild(meta);
      return row;
    }

    function renderRecs(list){
      recsList.innerHTML = '';
      recsListRight.innerHTML = '';
      list.forEach(item => {
        recsList.appendChild(buildRecRow(item));
        recsListRight.appendChild(buildRecRow(item).cloneNode(true));
      });

      // responsive right column
      if (window.innerWidth >= 1000) {
        recsRight.style.display = 'block';
        recsMobile.style.display = 'none';
      } else {
        recsRight.style.display = 'none';
        recsMobile.style.display = 'block';
      }
    }

    function linkifyText(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(url) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function pickRandom(arr, n, exclude){
      const pool = arr.filter(x => x && x.videoId && x.videoId !== exclude);
      for (let i = pool.length -1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [pool[i], pool[j]] = [pool[j], pool[i]]; }
      return pool.slice(0,n);
    }

    async function loadRecommendations(videoId){
      let pool = [];

      // 1) Prefer Firestore products (real items only). Query: products where demo != true OR where demo field missing.
      if (firestoreAvailable && db) {
        try {
          // attempt to fetch some random products (Firestore doesn't support server random; fetch recent then shuffle)
          const snap = await db.collection('products').orderBy('createdAt','desc').limit(100).get();
          snap.forEach(doc => {
            const d = doc.data();
            if (!d) return;
            // skip demo flag
            if (d.demo === true) return;
            // require at least image or videoId/sku to identify
            if (!d.thumbnail && !d.videoId && !d.imageUrl) return;
            // normalize into rec item (prefer a videoId if present)
            pool.push({
              videoId: d.videoId || d.videoId || '',
              title: d.title || d.name || (d.productName || ''),
              channelTitle: d.brand || d.seller || '',
              thumb: d.thumbnail || d.imageUrl || (d.videoId ? `https://i.ytimg.com/vi/${d.videoId}/hqdefault.jpg` : '')
            });
          });
        } catch(e) {
          // ignore error
        }
      }

      // 2) If no products, use community_videos collection
      if (pool.length === 0 && firestoreAvailable && db) {
        try {
          const snap = await db.collection('community_videos').orderBy('createdAt','desc').limit(100).get();
          snap.forEach(doc => {
            const d = doc.data();
            if (!d || !d.videoId) return;
            if (d.videoId === videoId) return;
            pool.push({
              videoId: d.videoId,
              title: d.title || '',
              channelTitle: d.channelTitle || d.uploaderName || '',
              thumb: d.thumbnailUrl || `https://i.ytimg.com/vi/${d.videoId}/hqdefault.jpg`
            });
          });
        } catch(e){
          // ignore
        }
      }

      // 3) If still empty and API_KEY available, fetch related via YouTube API
      if (pool.length === 0 && API_KEY) {
        const related = await fetchRelated(videoId, 20).catch(()=>[]);
        related.forEach(it => { if (it && it.videoId) pool.push(it); });
      }

      // 4) dedupe & pick random subset up to 12
      const uniq = [];
      const seen = new Set();
      for (const it of pool) {
        // if item has no videoId, but it's a product, we still include if it has thumb + title; create a synthetic id
        const id = it.videoId && it.videoId.length === 11 ? it.videoId : (it.title || '') + '|' + (it.thumb || '');
        if (!id || seen.has(id)) continue;
        seen.add(id);
        // require thumb + title to appear real
        if (!it.title || !it.thumb) continue;
        uniq.push(Object.assign({}, it, { videoId: it.videoId && it.videoId.length===11 ? it.videoId : id }));
      }

      // shuffle then take up to 12
      for (let i = uniq.length -1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [uniq[i], uniq[j]] = [uniq[j], uniq[i]]; }
      return uniq.slice(0,12);
    }

    // request fullscreen on container
    async function requestContainerFullscreen(){
      const el = playerSticky;
      if (!el) return;
      if (el.requestFullscreen) await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) await el.msRequestFullscreen();
    }
    function exitFullscreen(){
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    }

    // ---------- RENDER VIDEO PAGE ----------
    async function render(videoId){
      if (!videoId) {
        setText(titleEl, 'Invalid video');
        playerEl.innerHTML = '<div style="padding:18px;color:#fff">No video supplied. Use ?vid=&lt;YouTubeID or URL&gt;</div>';
        return;
      }
      currentVideoId = videoId;

      // placeholders
      setText(titleEl, 'Loading…');
      setText(viewsEl, '— views');
      setText(likesPill, '— likes');
      setText(channelNameEl, '—');
      setText(channelSubsEl, '');
      descText.textContent = 'Loading description…';
      descLinks.innerHTML = '';

      // iframe
      iframe = createIframe(videoId);
      playerEl.innerHTML = '';
      playerEl.appendChild(iframe);

      // fetch video details (prefer API, fallback to oEmbed)
      let info = null;
      if (API_KEY) info = await fetchVideoDetails(videoId).catch(()=>null);
      const oembed = (!info) ? await fetchOEmbed(videoId).catch(()=>null) : null;

      // title & channel
      const titleText = (info && info.snippet && info.snippet.title) || (oembed && oembed.title) || `Video ${videoId}`;
      setText(titleEl, titleText);

      const channelTitle = (info && info.snippet && info.snippet.channelTitle) || (oembed && oembed.author_name) || '';
      const channelId = info && info.snippet && info.snippet.channelId ? info.snippet.channelId : null;

      if (channelId && API_KEY) {
        const ch = await fetchChannel(channelId).catch(()=>null);
        if (ch && ch.snippet) {
          const avatar = ch.snippet.thumbnails?.default?.url || ch.snippet.thumbnails?.medium?.url || '';
          if (avatar) avatarEl.src = avatar;
          setText(channelNameEl, ch.snippet.title || channelTitle || '');
          if (ch.statistics && ch.statistics.subscriberCount !== undefined) {
            setText(channelSubsEl, `${niceNumber(ch.statistics.subscriberCount)} subscribers`);
          } else {
            setText(channelSubsEl, '');
          }
        } else {
          avatarEl.src = '';
          setText(channelNameEl, channelTitle || '');
        }
      } else {
        avatarEl.src = '';
        setText(channelNameEl, channelTitle || '');
      }

      // stats
      if (info && info.statistics) {
        setText(viewsEl, `${niceNumber(info.statistics.viewCount)} views`);
        if (info.statistics.likeCount !== undefined) setText(likesPill, `${niceNumber(info.statistics.likeCount)} likes`);
        else setText(likesPill, '— likes');
      } else {
        setText(viewsEl, '— views');
        setText(likesPill, '— likes');
      }

      // description & link chips
      const desc = (info && info.snippet && info.snippet.description) || '';
      descText.innerHTML = linkifyText(desc || '');
      descLinks.innerHTML = '';
      const linkMatches = String(desc || '').match(/https?:\/\/[^\s)]+/g) || [];
      linkMatches.slice(0,8).forEach(l => {
        const a = document.createElement('a'); a.className = 'link-chip'; a.href = l; a.target = '_blank'; a.rel = 'noopener noreferrer';
        let label = l.replace(/^https?:\/\//,'').replace(/\/.*$/,'');
        if (label.length > 28) label = label.slice(0,25) + '…';
        a.textContent = label;
        descLinks.appendChild(a);
      });

      // Recommendations logic
      const recs = await loadRecommendations(videoId);
      recommendations = recs;
      renderRecs(recs);

      // render lucide icons if present
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        try { window.lucide.createIcons({ className: 'lucide' }); } catch(e) {}
      }
    }

    // ---------- EVENTS ----------
    // subscribe toggle
    subscribeBtn.addEventListener('click', () => {
      if (subscribeBtn.classList.contains('subscribed')) {
        subscribeBtn.classList.remove('subscribed'); subscribeBtn.textContent = 'Subscribe'; subscribeBtn.style.background = 'var(--accent)';
      } else {
        subscribeBtn.classList.add('subscribed'); subscribeBtn.textContent = 'Subscribed'; subscribeBtn.style.background = '#9b9b9b';
      }
    });

    // description toggle (accessible)
    descToggle.addEventListener('click', () => {
      const open = !descBody.classList.contains('open');
      if (open) {
        descBody.classList.add('open'); descBody.setAttribute('aria-hidden','false'); descToggle.setAttribute('aria-expanded','true'); descState.textContent = 'Show less';
      } else {
        descBody.classList.remove('open'); descBody.setAttribute('aria-hidden','true'); descToggle.setAttribute('aria-expanded','false'); descState.textContent = 'Show more';
      }
    });
    descToggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); descToggle.click(); } });

    // double click for fullscreen on player
    playerEl.addEventListener('dblclick', async () => { try { await requestContainerFullscreen(); } catch(e){} });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'f' || e.key === 'F') { requestContainerFullscreen().catch(()=>{}); }
      else if (e.key === 'Escape' && document.fullscreenElement) exitFullscreen();
    });

    function handleResize(){
      if (window.innerWidth >= 1000) {
        recsRight.style.display = 'block';
        recsMobile.style.display = 'none';
      } else {
        recsRight.style.display = 'none';
        recsMobile.style.display = 'block';
      }
    }
    window.addEventListener('resize', handleResize);

    // ---------- BOOT ----------
    document.addEventListener('DOMContentLoaded', async () => {
      // draw icons
      try { if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons({ className: 'lucide' }); } catch(e){}
      handleResize();

      const vid = extractYouTubeID(rawVid || '');
      if (!vid) {
        setText(titleEl, 'Invalid video');
        playerEl.innerHTML = '<div style="padding:18px;color:#fff">No video supplied. Use ?vid=&lt;YouTubeID or URL&gt;</div>';
        return;
      }
      await render(vid);
    });

    // expose minimal API
    window.CommunityPlayer = { requestFullscreen: requestContainerFullscreen, exitFullscreen };

  })();
  </script>

  <script>
  // redraw lucide icons after lucide script loads
  window.addEventListener('load', () => {
    try { if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons({ className: 'lucide' }); } catch(e){}
  });
  </script>
</body>
</html>
